local Players = game:GetService("Players")

-- [FIX] Chờ PlayerGui load xong (Quan trọng cho việc click UI)
repeat task.wait() until Players.LocalPlayer
local LocalPlayer = Players.LocalPlayer
repeat task.wait() until LocalPlayer:FindFirstChild("PlayerGui")

local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
-- local LocalPlayer = Players.LocalPlayer -- (Đã define ở trên)

local TweenService = game:GetService("TweenService")

print(">>> TP-PVP Script Loading... (Version 3.3 - Smooth Fly)") -- Debug print

-- [[ CẤU HÌNH ]] --
local CONFIG = {
    TargetCFrame = CFrame.new(-191.22, 149.75, -226.96), -- Tọa độ user yêu cầu
    Team = "Pirates", -- Tự động chọn Hải Tặc
}

local DeathCount = 0
local isRunning = true
local MAX_DEATHS = 3 -- Số lần chết tối đa trước khi đổi acc
local hasResetStats = false -- Biến kiểm tra đã reset stats chưa

-- [[ UI HIỂN THỊ SỐ LẦN CHẾT ]] --
local function CreateDeathCounterUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "DeathCounterUI"
    
    -- [FIX] Thử CoreGui, nếu lỗi thì dùng PlayerGui
    local success, err = pcall(function()
        ScreenGui.Parent = game:GetService("CoreGui")
    end)
    
    if not success then
        if LocalPlayer:FindFirstChild("PlayerGui") then
            ScreenGui.Parent = LocalPlayer.PlayerGui
        end
    end
    
    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0, 200, 0, 50)
    Frame.Position = UDim2.new(0.5, -100, 0.1, 0)
    Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    Frame.BackgroundTransparency = 0.5
    Frame.Parent = ScreenGui
    
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(1, 0, 1, 0)
    Label.BackgroundTransparency = 1
    Label.TextColor3 = Color3.fromRGB(255, 0, 0)
    Label.TextSize = 20
    
    -- [FIX] Dùng Font cơ bản nhất để tránh lỗi
    pcall(function()
        Label.Font = Enum.Font.SourceSansBold 
    end)
    if Label.Font == nil then Label.Font = Enum.Font.SourceSans end

    Label.Text = "Số lần chết: 0 / " .. MAX_DEATHS
    Label.Parent = Frame
    
    return Label
end

local DeathLabel = CreateDeathCounterUI()

-- [[ HÀM HỖ TRỢ GỬI TÍN HIỆU ]] --
local function SendChangeAccountSignal()
    print(">>> [CHANGE ACCOUNT] Đã chết quá 3 lần! Gửi tín hiệu đổi tài khoản...")
    
    -- Cách 1: Gọi hàm Global từ auto.txt (Nếu có)
    if getgenv and getgenv().SignalChangeAccount then
        print(">>> Gọi Global SignalChangeAccount...")
        getgenv().SignalChangeAccount()
        return
    end

    -- Cách 2: Tự gửi tín hiệu nếu không chạy cùng auto.txt
    local pkgName = "Unknown"
    
    -- Thử lấy tên Package từ appStorage.json (để Python biết chính xác emulator nào)
    pcall(function()
        if isfile and isfile("appStorage.json") then
             local c = readfile("appStorage.json")
             local data = HttpService:JSONDecode(c)
             if data and data.PkgName then
                 pkgName = data.PkgName
             end
        end
    end)
    print(">>> Using Package Name: " .. pkgName)
    
    local signalName = "ChangeAccount"
    
    local function send()
        local body = HttpService:JSONEncode({
            package = pkgName,
            signal = signalName,
            nonce = tostring(math.random(100000, 999999)),
            Account = LocalPlayer.Name -- Gửi kèm tên acc
        })
        
        local reqFunc = (syn and syn.request) or (http and http.request) or http_request or request or (fluxus and fluxus.request)
        
        -- 1. Gửi HTTP POST
        if reqFunc then
            task.spawn(function()
                pcall(function()
                    reqFunc({
                        Url = "http://127.0.0.1:8000/signal",
                        Method = "POST",
                        Headers = {["Content-Type"] = "application/json"},
                        Body = body
                    })
                end)
            end)
            -- Backup cho Emulator
            task.spawn(function()
                pcall(function()
                    reqFunc({
                        Url = "http://10.0.2.2:8000/signal",
                        Method = "POST",
                        Headers = {["Content-Type"] = "application/json"},
                        Body = body
                    })
                end)
            end)
        end
        
        -- 2. Ghi file appStorage.json (Backup)
        local js = {}
        pcall(function()
            if isfile and isfile("appStorage.json") then
                 local c = readfile("appStorage.json")
                 js = HttpService:JSONDecode(c)
            end
        end)
        js.Signal = signalName
        js.Nonce = tostring(math.random(100000, 999999))
        js.Heartbeat = os.time()
        
        local content = HttpService:JSONEncode(js)
        pcall(function() writefile("appStorage.json", content) end)
    end

    -- Loop gửi tín hiệu mỗi 5s
    task.spawn(function()
        while true do
            print(">>> [LOOP] Đang gửi yêu cầu ChangeAccount...")
            send()
            task.wait(5)
        end
    end)
end


-- [[ CÁC HÀM LOGIC GAME ]] --

-- Hàm chọn phe (Cải tiến: Loop liên tục & Scan kỹ hơn giống auto.txt)
local function AutoChooseTeam()
    local t0 = os.clock()
    -- Loop tối đa 60 giây (tăng thời gian chờ)
    while LocalPlayer.Team == nil and (os.clock() - t0 < 60) do
        -- Cách 1: Dùng Remote
        pcall(function()
            local args = {[1] = "SetTeam", [2] = CONFIG.Team}
            ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args))
        end)
        
        -- Cách 2: Click UI (Logic giống auto.txt)
        if LocalPlayer.Team == nil then
            local function click(btn)
                if not btn then return end
                local vim = game:GetService("VirtualInputManager")
                local pos = btn.AbsolutePosition + (btn.AbsoluteSize/2)
                pcall(function()
                    vim:SendMouseButtonEvent(pos.X, pos.Y, 0, true, btn, 0)
                    task.wait(0.05)
                    vim:SendMouseButtonEvent(pos.X, pos.Y, 0, false, btn, 0)
                end)
            end
            
            -- Scan CoreGui
            pcall(function()
                for _, v in ipairs(game:GetService("CoreGui"):GetDescendants()) do
                    if (v:IsA("TextButton") or v:IsA("ImageButton")) then
                        local name = v.Name:lower()
                        local text = (v:IsA("TextButton") and v.Text:lower()) or ""
                        if name:find("pirate") or text:find("pirate") then
                            print(">>> [CoreGui] Click chọn phe: " .. v.Name)
                            click(v)
                        end
                    end
                end
            end)

            -- Scan PlayerGui
            if LocalPlayer:FindFirstChild("PlayerGui") then
                pcall(function()
                    for _, v in ipairs(LocalPlayer.PlayerGui:GetDescendants()) do
                        if (v:IsA("TextButton") or v:IsA("ImageButton")) then
                            local name = v.Name:lower()
                            local text = (v:IsA("TextButton") and v.Text:lower()) or ""
                            if name:find("pirate") or text:find("pirate") then
                                print(">>> [PlayerGui] Click chọn phe: " .. v.Name)
                                click(v)
                            end
                        end
                    end
                end)
            end
        end
        
        task.wait(1) -- Thử lại mỗi 1 giây
    end
end

-- Hàm bật PVP
local function EnablePVP()
    pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("EnablePvp")
    end)
    pcall(function()
        ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer("/pvp", "All")
    end)
end

-- Hàm bay (Tween) - Thay thế cho TP tức thời
local function TweenFly(targetCFrame)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then return end
    
    local root = char.HumanoidRootPart
    local dist = (root.Position - targetCFrame.Position).Magnitude
    
    -- Nếu gần thì return để Lock lo
    if dist <= 50 then return end

    print(">>> Đang bay tới mục tiêu... Khoảng cách: " .. math.floor(dist))
    
    local speed = 300 -- Tốc độ bay (Studs/s) - Chuẩn an toàn
    local duration = dist / speed
    
    local ti = TweenInfo.new(duration, Enum.EasingStyle.Linear)
    local tween = TweenService:Create(root, ti, {CFrame = targetCFrame})
    
    -- BodyVelocity để giữ nhân vật không bị rơi/giật
    local bv = Instance.new("BodyVelocity")
    bv.Velocity = Vector3.zero
    bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
    bv.Parent = root
    
    -- NoClip khi bay
    local noclipConn
    noclipConn = RunService.Stepped:Connect(function()
        if char then
            for _, v in pairs(char:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
            if root then root.Velocity = Vector3.zero end
        end
    end)
    
    tween:Play()
    tween.Completed:Wait()
    
    if noclipConn then noclipConn:Disconnect() end
    if bv then bv:Destroy() end
end

-- Hàm khóa vị trí (Chỉ chạy khi đã ở gần)
local function LockPositionLoop()
    RunService.Stepped:Connect(function()
        if not isRunning then return end
        
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") then
            if char.Humanoid.Health > 0 then
                local dist = (char.HumanoidRootPart.Position - CONFIG.TargetCFrame.Position).Magnitude
                
                -- Chỉ khóa cứng khi đã ở gần (< 50m)
                if dist <= 50 then
                    char.HumanoidRootPart.CFrame = CONFIG.TargetCFrame
                    char.HumanoidRootPart.Velocity = Vector3.zero
                    char.HumanoidRootPart.RotVelocity = Vector3.zero
                end
            end
        end
    end)
end

-- [[ LOGIC CHÍNH ]] --

local function OnCharacterAdded(char)
    -- Kiểm tra số lần chết TRƯỚC khi làm gì cả
    if DeathCount >= MAX_DEATHS then
        print("Đã đạt giới hạn chết (" .. MAX_DEATHS .. "). Đang chờ đổi acc...")
        SendChangeAccountSignal()
        return -- Dừng mọi hoạt động khác
    end

    print("Nhân vật vừa hồi sinh/vào game...")
    task.wait(1) -- Chờ load game
    
    -- 1. Chọn phe ngay lập tức
    AutoChooseTeam()
    task.wait(0.5)

    -- [NEW] Reset Stats (Chạy 1 lần duy nhất)
    -- [[ TẠM TẮT THEO YÊU CẦU USER
    if not hasResetStats then
        -- print("--- BẮT ĐẦU RESET STATS BẰNG FRAGMENTS (2,500F) ---")
        -- pcall(function()
        --     local Remote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("CommF_")
        --     local result = Remote:InvokeServer("BlackbeardReward", "Refund", "2")
        --     print("Kết quả Reset Stats: ", tostring(result))
        -- end)
        -- hasResetStats = true
        -- print("Đã hoàn tất lệnh Reset Stats (Sẽ không chạy lại).")
        -- print("Kiểm tra điểm xem đã về 0 chưa.")
    end
    -- ]]
    
    -- 2. (ĐÃ BỎ) Không TP tức thời nữa
    -- if char:FindFirstChild("HumanoidRootPart") then
    --     char.HumanoidRootPart.CFrame = CONFIG.TargetCFrame
    -- end
    
    -- 3. Bật PVP
    task.wait(1)
    EnablePVP()
    print("Đã yêu cầu bật PVP")
    
    -- 4. Lắng nghe sự kiện chết
    local hum = char:WaitForChild("Humanoid")
    hum.Died:Connect(function()
        DeathCount = DeathCount + 1
        DeathLabel.Text = "Số lần chết: " .. DeathCount .. " / " .. MAX_DEATHS
        print("Đã chết! Tổng số lần chết: " .. DeathCount)
        
        if DeathCount >= MAX_DEATHS then
            print(">>> ĐÃ CHẾT ĐỦ 3 LẦN! KÍCH HOẠT ĐỔI ACC...")
            SendChangeAccountSignal()
            isRunning = false -- Dừng khóa vị trí
        end
    end)
end

-- Kết nối sự kiện
LocalPlayer.CharacterAdded:Connect(OnCharacterAdded)

-- [FIX] Chạy chọn phe ngay lập tức (Không chờ CharacterAdded vì đang ở màn hình chọn phe)
task.spawn(function()
    if LocalPlayer.Team == nil then
        print(">>> Đang ở màn hình chọn phe -> Auto Pick Team...")
        AutoChooseTeam()
    end
end)

-- Chạy lần đầu nếu nhân vật đã có sẵn
if LocalPlayer.Character then
    OnCharacterAdded(LocalPlayer.Character)
end

-- Bắt đầu vòng lặp khóa vị trí (Logic mới)
LockPositionLoop()

-- Vòng lặp kiểm tra trạng thái định kỳ và bay nếu cần
spawn(function()
    while isRunning do
        task.wait(1) -- Check mỗi giây
        
        if DeathCount >= MAX_DEATHS then
            break -- Thoát vòng lặp nếu đã chết đủ
        end

        -- Cứ 5 giây gửi lệnh bật PVP một lần cho chắc
        if os.time() % 5 == 0 then
             EnablePVP()
        end
        
        -- Nếu đang sống mà ở xa thì bay tới
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0 then
            local dist = (char.HumanoidRootPart.Position - CONFIG.TargetCFrame.Position).Magnitude
            if dist > 50 then
                TweenFly(CONFIG.TargetCFrame)
            end
        end
    end
end)

print("Script TP-PVP đã kích hoạt!")
print("Tọa độ khóa: " .. tostring(CONFIG.TargetCFrame))
print("Giới hạn chết: " .. MAX_DEATHS .. " lần -> Đổi Account")
