--[[
UI 2 NÚT: THẢ / THU (BẢN THẢ = CẦM LÊN RỒI ĐẶT)
- THẢ: tìm pet theo tên trong Backpack -> Equip lên nhân vật -> cố gắng "đặt" xuống vườn
- THU : recall toàn bộ (remote nếu có, fallback đưa Tool về Backpack)
]]

-- ===== CẤU HÌNH =====
getgenv().CFG = {
    PET_KEYWORD = "Moon Cat",            -- tên/chuỗi cần khớp (bắt cả "Moon Cat (2)" ...)
    MAX_TO_PLACE = 7,                    -- số lượng cần thả
    BETWEEN_EACH = 0.08,                 -- delay nhỏ giữa mỗi lần thả

    -- Ưu tiên các cách "đặt" theo thứ tự:
    TRY_ACTIVATE = true,                 -- tool:Activate()
    TRY_FIRE_REMOTE_CHILDREN = true,     -- FireServer tất cả RemoteEvent trong tool (Place/Deploy/Activate,...)
    TRY_CLICK_TAP = true,                -- giả lập click/tap 1 cái để đặt

    -- Remote recall (nếu game có):
    RECALL_BANG_REMOTE = true,
    RECALL_REMOTE_PATH = "ReplicatedStorage.Remotes.RecallAllPets",

    -- Vị trí click mặc định: ngay trước mặt nhân vật 6 studs (đủ an toàn)
    CLICK_FORWARD_STUDS = 6,
}

-- ===== DỊCH VỤ =====
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local VIM = game:GetService("VirtualInputManager")
local LP = Players.LocalPlayer
local Character = LP.Character or LP.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HRP = Character:WaitForChild("HumanoidRootPart")
local Backpack = LP:WaitForChild("Backpack")
local PlayerGui = LP:WaitForChild("PlayerGui")

local function waitx(t) task.wait(t or 0) end

local function byPath(pathStr)
    if not pathStr or pathStr=="" then return nil end
    local n = game
    for seg in string.gmatch(pathStr,"[^%.]+") do
        n = n:FindFirstChild(seg)
        if not n then return nil end
    end
    return n
end

local recallRemote = nil
if getgenv().CFG.RECALL_BANG_REMOTE then
    recallRemote = byPath(getgenv().CFG.RECALL_REMOTE_PATH)
end

-- ===== HÀM BỔ TRỢ =====
local function nameMatch(toolName, keyword)
    -- khớp mềm: chứa keyword (không phân biệt hoa/thường)
    toolName = string.lower(toolName or "")
    keyword = string.lower(keyword or "")
    return string.find(toolName, keyword, 1, true) ~= nil
end

local function equipTool(tool)
    -- đảm bảo cầm trên tay
    pcall(function() Humanoid:EquipTool(tool) end)
    tool.Parent = Character
    waitx(0.05)
end

local function toolTryActivate(tool)
    -- 1) cố Activate
    if getgenv().CFG.TRY_ACTIVATE and tool and tool:IsA("Tool") then
        pcall(function() tool:Activate() end)
        waitx(0.05)
    end
    -- 2) bắn tất cả RemoteEvent con (Place/Deploy/Activate/Use...)
    if getgenv().CFG.TRY_FIRE_REMOTE_CHILDREN and tool then
        for _,child in ipairs(tool:GetDescendants()) do
            if child.ClassName == "RemoteEvent" then
                -- gửi vị trí trước mặt để nhiều tool hiểu được
                local targetPos = HRP.Position + HRP.CFrame.LookVector * getgenv().CFG.CLICK_FORWARD_STUDS
                local payload = targetPos
                -- nhiều game chỉ cần nil / true / {} – thử những biến thể an toàn
                pcall(function() child:FireServer(payload) end)
                waitx(0.02)
            end
        end
    end
end

local function screenCenter()
    local cam = workspace.CurrentCamera
    local vp = cam.ViewportSize
    return vp.X/2, vp.Y/2
end

local function tryClickTap()
    if not getgenv().CFG.TRY_CLICK_TAP then return end
    local x, y = screenCenter()
    -- Giả lập 1 lần click/tap giữa màn hình
    pcall(function()
        if UIS.TouchEnabled and not UIS.MouseEnabled then
            VIM:SendTouchEvent(x, y, 1, true)  -- press
            VIM:SendTouchEvent(x, y, 1, false) -- release
        else
            VIM:SendMouseButtonEvent(x, y, 0, true, game, 0)  -- down
            VIM:SendMouseButtonEvent(x, y, 0, false, game, 0) -- up
        end
    end)
end

local function placeOne(tool)
    if not tool or not tool:IsA("Tool") then return false end
    equipTool(tool)
    toolTryActivate(tool)
    tryClickTap()
    waitx(0.05)
    return true
end

local function dropMoonCats()
    local need = getgenv().CFG.MAX_TO_PLACE
    local keyword = getgenv().CFG.PET_KEYWORD
    local placed = 0

    -- lượt 1: theo thứ tự ổn định của Backpack (để hạn chế double)
    for _,it in ipairs(Backpack:GetChildren()) do
        if placed >= need then break end
        if it:IsA("Tool") and nameMatch(it.Name, keyword) then
            if placeOne(it) then
                placed += 1
                waitx(getgenv().CFG.BETWEEN_EACH)
            end
        end
    end

    -- lượt 2: nếu trong lúc đặt có item mới vừa vào Backpack (tránh sót)
    if placed < need then
        for _,it in ipairs(Backpack:GetChildren()) do
            if placed >= need then break end
            if it:IsA("Tool") and nameMatch(it.Name, keyword) then
                if placeOne(it) then
                    placed += 1
                    waitx(getgenv().CFG.BETWEEN_EACH)
                end
            end
        end
    end

    print(("[PetUI] ĐÃ THẢ %d/%d \"%s\""):format(placed, need, keyword))
    return placed
end

local function recallAll()
    if recallRemote and recallRemote:IsA("RemoteEvent") then
        pcall(function() recallRemote:FireServer() end)
        return true
    end
    -- fallback: đưa mọi Tool đang cầm về Backpack
    for _,v in ipairs(Character:GetChildren()) do
        if v:IsA("Tool") then
            v.Parent = Backpack
            waitx(0.03)
        end
    end
    return true
end

-- ===== UI 2 NÚT =====
local sg = Instance.new("ScreenGui")
sg.Name = "PetTwoButtonsUI"
sg.ResetOnSpawn = false
sg.IgnoreGuiInset = true
sg.Parent = PlayerGui

local frame = Instance.new("Frame", sg)
frame.Name = "Dock"
frame.AnchorPoint = Vector2.new(1,1)
frame.Position = UDim2.new(1, -16, 1, -140)
frame.Size = UDim2.new(0, 170, 0, 100)
frame.BackgroundColor3 = Color3.fromRGB(28, 28, 33)

local uic = Instance.new("UICorner", frame); uic.CornerRadius = UDim.new(0, 14)
local stroke = Instance.new("UIStroke", frame); stroke.Thickness = 1; stroke.Transparency = 0.25
local pad = Instance.new("UIPadding", frame); pad.PaddingTop = UDim.new(0,10); pad.PaddingBottom = UDim.new(0,10); pad.PaddingLeft = UDim.new(0,10); pad.PaddingRight = UDim.new(0,10)

local list = Instance.new("UIListLayout", frame)
list.FillDirection = Enum.FillDirection.Vertical
list.Padding = UDim.new(0, 10)
list.HorizontalAlignment = Enum.HorizontalAlignment.Center
list.VerticalAlignment = Enum.VerticalAlignment.Center

local function makeBtn(txt, color3)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1, 0, 0, 36)
    b.Text = txt
    b.Font = Enum.Font.GothamBold
    b.TextSize = 16
    b.TextColor3 = Color3.fromRGB(255,255,255)
    b.BackgroundColor3 = color3 or Color3.fromRGB(55,115,255)
    local c = Instance.new("UICorner", b); c.CornerRadius = UDim.new(0, 10)
    local s = Instance.new("UIStroke", b); s.Thickness = 1; s.Transparency = 0.3
    return b
end

local btnDrop = makeBtn("THẢ (Moon Cat)")
local btnRecall = makeBtn("THU", Color3.fromRGB(245,90,90))
btnDrop.Parent = frame
btnRecall.Parent = frame

-- Kéo thả khung
local dragging = false
local dragStart, startPos
frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
UIS.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Debounce ngắn
local busy = false
local function withBusy(fn)
    if busy then return end
    busy = true
    task.spawn(function()
        local ok, err = pcall(fn)
        if not ok then warn("[PetUI] Error:", err) end
        busy = false
    end)
end

-- Sự kiện nút
btnDrop.MouseButton1Click:Connect(function()
    withBusy(function()
        dropMoonCats()
    end)
end)

btnRecall.MouseButton1Click:Connect(function()
    withBusy(function()
        recallAll()
        print("[PetUI] ĐÃ THU TẤT CẢ PET")
    end)
end)

print("[PetUI] Sẵn sàng. Nút THẢ sẽ cầm Tool rồi đặt 7 \""..getgenv().CFG.PET_KEYWORD.."\".")
