-- ===== CONFIG =====
local PLACE_ID        = 126884695634066
local TARGET_VERSION  = 1681          -- muốn tìm v1681
local PLAYER_MAX      = 1            -- chỉ vào server có số người <= giá trị này
local MAX_PAGES       = 25            -- số trang tối đa cần quét (mỗi trang ~100 sv)
local CHECK_DELAY     = 2             -- chờ UI load sau khi vào server (giây)

-- ===== SERVICES =====
local TS = game:GetService("TeleportService")
local HS = game:GetService("HttpService")
local Players = game:GetService("Players")
local LP = Players.LocalPlayer

-- ===== UI nhỏ gọn =====
local function ui()
    local sg = Instance.new("ScreenGui")
    sg.Name = "FindOldLowPop"
    sg.IgnoreGuiInset = true
    sg.ResetOnSpawn = false
    sg.Parent = LP:WaitForChild("PlayerGui")

    local f = Instance.new("Frame", sg)
    f.BackgroundColor3 = Color3.fromRGB(30,30,30)
    f.BackgroundTransparency = 0.15
    f.BorderSizePixel = 0
    f.Position = UDim2.fromScale(.75,.06)
    f.Size = UDim2.fromOffset(340,130)
    f.Active = true; f.Draggable = true
    Instance.new("UIStroke", f).Color = Color3.fromRGB(90,90,90)
    local pad = Instance.new("UIPadding", f)
    pad.PaddingTop, pad.PaddingBottom = UDim.new(0,10), UDim.new(0,10)
    pad.PaddingLeft, pad.PaddingRight = UDim.new(0,12), UDim.new(0,12)

    local title = Instance.new("TextLabel", f)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Text = ("Tìm v%d (ưu tiên server ít người)"):format(TARGET_VERSION)
    title.TextColor3 = Color3.new(1,1,1)
    title.Size = UDim2.new(1,0,0,22)

    local info = Instance.new("TextLabel", f); info.Name="Info"
    info.Position = UDim2.fromOffset(0,26)
    info.Size = UDim2.new(1,0,0,20)
    info.BackgroundTransparency=1; info.Font=Enum.Font.Gotham; info.TextSize=14
    info.TextXAlignment=Enum.TextXAlignment.Left; info.TextColor3=Color3.fromRGB(220,220,220)

    local st = Instance.new("TextLabel", f); st.Name="St"
    st.Position = UDim2.fromOffset(0,48)
    st.Size = UDim2.new(1,0,0,22)
    st.BackgroundTransparency=1; st.Font=Enum.Font.GothamMedium; st.TextSize=16
    st.TextXAlignment=Enum.TextXAlignment.Left; st.TextColor3=Color3.fromRGB(255,220,150)

    local job = Instance.new("TextLabel", f); job.Name="Job"
    job.Position = UDim2.fromOffset(0,74)
    job.Size = UDim2.new(1,0,0,20)
    job.BackgroundTransparency=1; job.Font=Enum.Font.Gotham; job.TextSize=14
    job.TextXAlignment=Enum.TextXAlignment.Left; job.TextColor3=Color3.fromRGB(200,255,200)
    job.Text = "JobId: "..(game.JobId or "N/A")

    local copy = Instance.new("TextButton", f)
    copy.Text="Copy JobId"; copy.Font=Enum.Font.GothamBold; copy.TextSize=14
    copy.TextColor3=Color3.new(1,1,1); copy.BackgroundColor3=Color3.fromRGB(60,140,60)
    copy.Position = UDim2.fromOffset(200, 92); copy.Size = UDim2.fromOffset(120,28)
    copy.MouseButton1Click:Connect(function()
        if setclipboard then setclipboard(game.JobId or "") copy.Text="Đã copy!" task.delay(1.2,function() copy.Text="Copy JobId" end) end
    end)

    return sg, info, st, job
end
local SG, LINFO, LST, LJOB = ui()

-- ===== đọc label vXXXX ở góc trái =====
local function readTopLeftV()
    local pg = LP:FindFirstChild("PlayerGui"); if not pg then return nil,nil end
    local bestScore, bestText, bestNum
    for _,d in ipairs(pg:GetDescendants()) do
        if d:IsA("TextLabel") or d:IsA("TextButton") or d:IsA("TextBox") then
            local tx = tostring(d.Text or "")
            local n = tx:match("[vV](%d+)")
            if n then
                local ok,pos = pcall(function() return d.AbsolutePosition end)
                if ok then
                    local s = pos.X + pos.Y -- càng nhỏ càng gần góc trái
                    if not bestScore or s < bestScore then
                        bestScore, bestText, bestNum = s, tx, tonumber(n)
                    end
                end
            end
        end
    end
    return bestText, bestNum
end

-- ===== tải trang server, lọc server ít người =====
local function fetchLowPop(cursor)
    local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100%s")
        :format(PLACE_ID, cursor and ("&cursor="..cursor) or "")
    local ok, body = pcall(function() return game:HttpGet(url) end)
    if not ok then return {data={}}, nil end
    local j = HS:JSONDecode(body)

    -- lấy server có playing <= PLAYER_MAX
    local bucket = {}
    for _,sv in ipairs(j.data or {}) do
        if typeof(sv.playing) == "number" and sv.playing <= PLAYER_MAX then
            table.insert(bucket, {id = sv.id, playing = sv.playing})
        end
    end
    -- sắp xếp tăng dần theo số người (ưu tiên 0/1 người)
    table.sort(bucket, function(a,b)
        if a.playing == b.playing then
            return a.id < b.id
        end
        return a.playing < b.playing
    end)

    return {data=bucket}, j.nextPageCursor
end

-- ===== state qua TeleportData để tiếp tục sau mỗi hop =====
local TD = TS:GetLocalPlayerTeleportData() or {}
local cursor = TD.cursor
local page  = TD.page or 0
local idx   = TD.idx  or 1
local list  = TD.list or {}

task.spawn(function()
    -- check server hiện tại trước
    task.wait(CHECK_DELAY)
    local txt,num = readTopLeftV()
    LINFO.Text = txt and ("Thấy: "..txt.." (num="..num..")") or "Chưa thấy vXXXX"
    LJOB.Text = "JobId: "..(game.JobId or "N/A")
    if num == TARGET_VERSION then
        LST.Text = ("✅ FOUND v%d — bấm Copy JobId"):format(TARGET_VERSION)
        LST.TextColor3 = Color3.fromRGB(140,255,140)
        return
    end

    LST.Text = ("⏳ Không đúng v%d → tìm server ít người..."):format(TARGET_VERSION)
    LST.TextColor3 = Color3.fromRGB(255,200,160)

    local pagesTried = 0
    while true do
        if idx > #list then
            if pagesTried >= MAX_PAGES then
                LST.Text = ("Hết giới hạn %d trang."):format(MAX_PAGES)
                return
            end
            local pack, nextCursor = fetchLowPop(cursor)
            cursor = nextCursor; page += 1; pagesTried += 1
            list, idx = {}, 1
            for _,sv in ipairs(pack.data or {}) do
                if sv.id ~= game.JobId then table.insert(list, sv.id) end
            end
            if #list == 0 and not cursor then
                LST.Text = "Không còn server ít người để thử."
                return
            end
        end

        local targetJob = list[idx]; idx += 1
        if targetJob and targetJob ~= game.JobId then
            LST.Text = ("Teleport → server ít người (候)"):gsub("候","…")
            local nextTD = {cursor = cursor, page = page, idx = idx, list = list}
            TS:TeleportToPlaceInstance(PLACE_ID, targetJob, LP, nextTD)
            break
        end
        task.wait(0.05)
    end
end)
