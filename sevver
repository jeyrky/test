--[[  GROW A GARDEN – AUTO LOOP (Recall -> Drop -> Wait 15s -> Repeat)
    • Luồng: THU → THẢ (Tri + Moon ở mốc) → HẾT GIỜ → CHỜ 15s → LẶP
    • HUD: chỉ đồng hồ Triceratops
    • Menu: màu xám, có thanh tiêu đề & nút "-" ẩn/hiện
    • Nút: BẮT ĐẦU AUTO, TẠM DỪNG/TIẾP TỤC, THẢ THỦ CÔNG, THU THỦ CÔNG, DỪNG HOÀN TOÀN
    • Thả Moon: THẢ HẾT (không giới hạn)
]]

-- ===== CẤU HÌNH =====
getgenv().CFG = {
    TRI_KEYWORD               = "Triceratops",
    MOON_KEYWORD              = "Moon Cat",

    TRI_INTERVAL_SEC          = 3*60 + 33,  -- 3:33 = 213s
    START_MOON_AT_LEFT        = 75,         -- khi Triceratops còn 1:15

    TRY_ACTIVATE              = true,
    TRY_FIRE_REMOTE_CHILDREN  = true,
    TRY_CLICK_TAP             = true,

    CLICK_FORWARD_STUDS       = 6,
    LOOP_COOLDOWN_SEC         = 15,         -- chờ 15s sau khi TRI hết giờ
}

-- Danh sách GUID pet cần thu lại
local PET_GUIDS = {
    "{b04576d7-9498-4193-9db1-e86fb10fc5a0}",
    "{2ef864b3-3d9f-486f-bbaf-9ce45d911a5a}",
    "{31ee4294-0d7c-4993-813f-2ca605226f39}",
    "{4220b635-bc02-4cb8-8e86-7959fdd1f06b}",
    "{2c871dfe-58d9-4a92-9993-939d2c41f0c9}",
    "{47cdba55-dcbc-4f40-8ea5-f00cff81ca55}",
    "{ab1786d6-7437-426f-b2ba-e144e82c7cab}",
    "{24eeef51-7e6a-46e6-8f01-fc23859cbfea}"
}

-- ===== DỊCH VỤ =====
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local VIM = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local RS = game:GetService("ReplicatedStorage")

local LP = Players.LocalPlayer
local Character = LP.Character or LP.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HRP = Character:WaitForChild("HumanoidRootPart")
local Backpack = LP:WaitForChild("Backpack")
local PlayerGui = LP:WaitForChild("PlayerGui")
local PetsService = RS:WaitForChild("GameEvents"):WaitForChild("PetsService")

-- ===== TIỆN ÍCH =====
local function nameMatch(toolName, keyword)
    return string.find(string.lower(toolName or ""), string.lower(keyword or ""), 1, true) ~= nil
end

local function equipTool(tool)
    pcall(function() Humanoid:EquipTool(tool) end)
    tool.Parent = Character
    task.wait(0.02)
end

local function toolTryActivate(tool)
    if getgenv().CFG.TRY_ACTIVATE and tool and tool:IsA("Tool") then
        pcall(function() tool:Activate() end)
    end
    if getgenv().CFG.TRY_FIRE_REMOTE_CHILDREN and tool then
        for _,child in ipairs(tool:GetDescendants()) do
            if child.ClassName == "RemoteEvent" then
                local pos = HRP.Position + HRP.CFrame.LookVector * getgenv().CFG.CLICK_FORWARD_STUDS
                pcall(function() child:FireServer(pos) end)
            end
        end
    end
end

local function screenCenter()
    local cam = workspace.CurrentCamera
    local vp = cam.ViewportSize
    return vp.X/2, vp.Y/2
end

local function tryClickTap()
    if not getgenv().CFG.TRY_CLICK_TAP then return end
    local x, y = screenCenter()
    pcall(function()
        if UIS.TouchEnabled and not UIS.MouseEnabled then
            VIM:SendTouchEvent(x, y, 1, true); VIM:SendTouchEvent(x, y, 1, false)
        else
            VIM:SendMouseButtonEvent(x, y, 0, true, game, 0)
            VIM:SendMouseButtonEvent(x, y, 0, false, game, 0)
        end
    end)
end

-- ===== THẢ: tất cả tool khớp keyword trong Backpack (không giới hạn) =====
local function placeAllByKeyword(keyword)
    local placed = 0
    for _,it in ipairs(Backpack:GetChildren()) do
        if it:IsA("Tool") and nameMatch(it.Name, keyword) then
            equipTool(it)
            toolTryActivate(it)
            tryClickTap()
            placed += 1
            task.wait(0.02) -- nhỏ để tránh nghẽn
        end
    end
    return placed
end

-- API chung: nếu có limitCount thì giới hạn, không thì thả hết
local function placeByKeywordFast(keyword, limitCount)
    if not limitCount then
        return placeAllByKeyword(keyword)
    end
    local placed = 0
    for _,it in ipairs(Backpack:GetChildren()) do
        if it:IsA("Tool") and nameMatch(it.Name, keyword) then
            equipTool(it); toolTryActivate(it); tryClickTap()
            placed += 1
            if placed >= limitCount then break end
            task.wait(0.02)
        end
    end
    return placed
end

-- ===== THU PET THEO GUID =====
local function recallByGUIDs()
    for _,guid in ipairs(PET_GUIDS) do
        pcall(function()
            PetsService:FireServer("UnequipPet", guid)
        end)
        task.wait(0.06)
    end
end

-- ===== HUD MINI (TRICERATOPS TIMER) =====
local function createMiniTimer()
    local f = Instance.new("Frame")
    f.Size = UDim2.fromOffset(170, 74)
    f.Position = UDim2.fromOffset(16, 120)
    f.BackgroundColor3 = Color3.fromRGB(40,40,40)
    f.BorderSizePixel = 0
    Instance.new("UICorner", f).CornerRadius = UDim.new(0,10)

    local title = Instance.new("TextLabel", f)
    title.BackgroundTransparency = 1
    title.Position = UDim2.fromOffset(8,6)
    title.Size = UDim2.new(1,-16,0,18)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 13
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextColor3 = Color3.fromRGB(220,220,220)
    title.Text = "Triceratops"

    local t = Instance.new("TextLabel", f)
    t.BackgroundTransparency = 1
    t.Position = UDim2.fromOffset(8,26)
    t.Size = UDim2.new(1,-16,0,26)
    t.Font = Enum.Font.GothamBlack
    t.TextSize = 22
    t.TextXAlignment = Enum.TextXAlignment.Left
    t.TextColor3 = Color3.fromRGB(255,255,255)
    t.Text = "--:--"

    local status = Instance.new("TextLabel", f)
    status.BackgroundTransparency = 1
    status.Position = UDim2.fromOffset(8,50)
    status.Size = UDim2.new(1,-16,0,18)
    status.Font = Enum.Font.Gotham
    status.TextSize = 12
    status.TextXAlignment = Enum.TextXAlignment.Left
    status.TextColor3 = Color3.fromRGB(200,200,200)
    status.Text = "IDLE"

    return f, t, status
end

local sg = Instance.new("ScreenGui", PlayerGui)
sg.Name = "TriPetTimerUI"
sg.ResetOnSpawn = false

local triFrame, triLabel, statusLabel = createMiniTimer()
triFrame.Parent = sg

local function fmt(sec)
    if sec<=0 then return "READY" end
    local m = math.floor(sec/60)
    local s = sec%60
    return string.format("%02d:%02d", m, s)
end

local triDeadline
RunService.RenderStepped:Connect(function()
    triLabel.Text = triDeadline and fmt(triDeadline - time()) or "--:--"
end)

local function setStatus(s) statusLabel.Text = s end
local function startTriTimer() triDeadline = time() + getgenv().CFG.TRI_INTERVAL_SEC end

-- ===== TRẠNG THÁI AUTO =====
local autoEnabled, paused, loopThread = false, false, nil

-- 1 CHU KỲ: THU → THẢ TRI → chờ mốc để THẢ HẾT MOON → chờ TRI hết → cooldown 15s
local function doOneCycle()
    if not autoEnabled then return end
    setStatus("THU pet...")
    recallByGUIDs()
    task.wait(0.3)

    if not autoEnabled then return end
    setStatus("THẢ Triceratops...")
    local triPlaced = placeByKeywordFast(getgenv().CFG.TRI_KEYWORD, 1)
    if triPlaced <= 0 then
        setStatus("Không thấy Tri trong Backpack")
        triDeadline = nil
        return
    end

    startTriTimer()
    setStatus("Đang đếm giờ...")

    local moonDropped = false
    while autoEnabled and triDeadline and (triDeadline - time()) > 0 do
        if paused then
            setStatus("ĐÃ TẠM DỪNG")
            repeat task.wait(0.1) until autoEnabled and not paused
            if not autoEnabled then break end
            setStatus("TIẾP TỤC")
        end

        local left = triDeadline - time()
        if (not moonDropped) and left <= getgenv().CFG.START_MOON_AT_LEFT then
            setStatus("THẢ HẾT Moon Cat...")
            placeByKeywordFast(getgenv().CFG.MOON_KEYWORD) -- KHÔNG GIỚI HẠN
            moonDropped = true
        end
        task.wait(0.05)
    end

    if not autoEnabled then return end
    setStatus("Hết giờ → chờ ".. tostring(getgenv().CFG.LOOP_COOLDOWN_SEC) .."s")
    triDeadline = nil
    local t0 = time()
    while autoEnabled and time() - t0 < getgenv().CFG.LOOP_COOLDOWN_SEC do
        if paused then
            setStatus("ĐÃ TẠM DỪNG")
            repeat task.wait(0.1) until autoEnabled and not paused
            if not autoEnabled then break end
            setStatus("TIẾP TỤC")
        end
        task.wait(0.1)
    end
end

local function runLoop()
    while autoEnabled do
        doOneCycle()
        if not autoEnabled then break end
    end
    setStatus("IDLE")
end

local function safeStopLoop()
    autoEnabled = false
    paused = false
    triDeadline = nil
    setStatus("ĐÃ DỪNG TOÀN BỘ")
end

-- ===== UI MENU XÁM + TIÊU ĐỀ & NÚT "-" ẨN/HIỆN =====
local dock = Instance.new("Frame", sg)
dock.AnchorPoint = Vector2.new(1,1)
dock.Position = UDim2.new(1, -16, 1, -120)
dock.Size = UDim2.fromOffset(220, 220)
dock.BackgroundColor3 = Color3.fromRGB(50,50,50) -- xám đồng nhất
dock.BorderSizePixel = 0
Instance.new("UICorner", dock).CornerRadius = UDim.new(0,14)

-- Thanh tiêu đề
local titleBar = Instance.new("Frame", dock)
titleBar.Size = UDim2.new(1,0,0,28)
titleBar.BackgroundColor3 = Color3.fromRGB(40,40,40)
titleBar.BorderSizePixel = 0
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0,14)

local titleLabel = Instance.new("TextLabel", titleBar)
titleLabel.BackgroundTransparency = 1
titleLabel.Size = UDim2.new(1,-28,1,0)
titleLabel.Position = UDim2.new(0,8,0,0)
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 14
titleLabel.TextColor3 = Color3.fromRGB(255,255,255)
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Text = "AUTO MENU"

local btnToggle = Instance.new("TextButton", titleBar)
btnToggle.Size = UDim2.fromOffset(20,20)
btnToggle.Position = UDim2.new(1,-24,0.5,-10)
btnToggle.BackgroundColor3 = Color3.fromRGB(70,70,70)
btnToggle.Text = "-"
btnToggle.TextColor3 = Color3.fromRGB(255,255,255)
btnToggle.Font = Enum.Font.GothamBold
btnToggle.TextSize = 14
Instance.new("UICorner", btnToggle).CornerRadius = UDim.new(0,6)

local content = Instance.new("Frame", dock)
content.Size = UDim2.new(1,0,1,-28)
content.Position = UDim2.new(0,0,0,28)
content.BackgroundTransparency = 1

local vlist = Instance.new("UIListLayout", content)
vlist.Padding = UDim.new(0,8)
vlist.HorizontalAlignment = Enum.HorizontalAlignment.Center
vlist.VerticalAlignment = Enum.VerticalAlignment.Top

btnToggle.MouseButton1Click:Connect(function()
    content.Visible = not content.Visible
    btnToggle.Text = content.Visible and "-" or "+"
end)

-- ===== NÚT =====
local function mkBtn(txt)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1,-16,0,36)
    b.Text = txt
    b.Font = Enum.Font.GothamBold
    b.TextSize = 15
    b.TextColor3 = Color3.fromRGB(255,255,255)
    b.BackgroundColor3 = Color3.fromRGB(80,80,80) -- xám
    b.BorderSizePixel = 0
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
    b.Parent = content
    return b
end

local btnAuto   = mkBtn("BẮT ĐẦU AUTO")
local btnPause  = mkBtn("TẠM DỪNG / TIẾP TỤC")
local btnDrop   = mkBtn("THẢ THỦ CÔNG")
local btnRecall = mkBtn("THU THỦ CÔNG")
local btnStop   = mkBtn("DỪNG HOÀN TOÀN")

-- ===== GÁN HÀNH ĐỘNG =====
btnAuto.MouseButton1Click:Connect(function()
    if autoEnabled then
        safeStopLoop()
        btnAuto.Text = "BẮT ĐẦU AUTO"
        return
    end
    autoEnabled = true
    paused = false
    btnAuto.Text = "ĐANG AUTO..."
    setStatus("BẮT ĐẦU AUTO")
    loopThread = task.spawn(runLoop)
end)

btnPause.MouseButton1Click:Connect(function()
    if not autoEnabled then setStatus("AUTO chưa bật"); return end
    paused = not paused
    btnPause.Text = paused and "TIẾP TỤC" or "TẠM DỪNG / TIẾP TỤC"
    setStatus(paused and "ĐÃ TẠM DỪNG" or "TIẾP TỤC")
end)

btnDrop.MouseButton1Click:Connect(function()
    if autoEnabled then return end
    setStatus("THẢ Tri + HẾT Moon (thủ công)")
    local triPlaced = placeByKeywordFast(getgenv().CFG.TRI_KEYWORD, 1)
    if triPlaced > 0 then
        triDeadline = time() + getgenv().CFG.TRI_INTERVAL_SEC
    end
    task.spawn(function()
        while triDeadline and (triDeadline - time()) > 0 do
            local left = triDeadline - time()
            if left <= getgenv().CFG.START_MOON_AT_LEFT then
                placeByKeywordFast(getgenv().CFG.MOON_KEYWORD) -- KHÔNG GIỚI HẠN
                break
            end
            task.wait(0.05)
        end
        setStatus("IDLE")
    end)
end)

btnRecall.MouseButton1Click:Connect(function()
    if autoEnabled then return end
    setStatus("THU pet (thủ công)")
    recallByGUIDs()
    triDeadline = nil
    setStatus("IDLE")
end)

btnStop.MouseButton1Click:Connect(function()
    safeStopLoop()
    btnAuto.Text = "BẮT ĐẦU AUTO"
end)

print("[TriTimer] AUTO LOOP – Gray UI + toggle, STOP stops all, drop ALL Moon at marker.")
