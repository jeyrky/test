--[[  GROW A GARDEN – AUTO LOOP (Recall -> Drop -> Wait 15s -> Repeat)
    • Luồng: THU → THẢ (Tri + Moon ở mốc) → HẾT GIỜ → CHỜ 15s → LẶP
    • HUD: chỉ đồng hồ Triceratops
    • Nút: BẮT ĐẦU AUTO, DỪNG/TIẾP TỤC, THẢ, THU
]]

-- ===== CẤU HÌNH =====
getgenv().CFG = {
    TRI_KEYWORD         = "Triceratops",
    MOON_KEYWORD        = "Moon Cat",

    TRI_INTERVAL_SEC    = 3*60 + 33,  -- 3:33 = 213s
    START_MOON_AT_LEFT  = 75,         -- khi Triceratops còn 1:15

    MAX_MOON_TO_PLACE   = 7,          -- số Moon Cat cần thả

    TRY_ACTIVATE        = true,
    TRY_FIRE_REMOTE_CHILDREN = true,
    TRY_CLICK_TAP       = true,

    CLICK_FORWARD_STUDS = 6,
    LOOP_COOLDOWN_SEC   = 15,         -- chờ 15s sau khi TRICERATOPS hết giờ
}

-- Danh sách GUID pet cần thu lại
local PET_GUIDS = {
    "{2c871dfe-58d9-4a92-9993-939d2c41f0c9}",
    "{2ef864b3-3d9f-486f-bbaf-9ce45d911a5a}",
    "{b04576d7-9498-4193-9db1-e86fb10fc5a0}",
    "{24eeef51-7e6a-46e6-8f01-fc23859cbfea}",
    "{4220b635-bc02-4cb8-8e86-7959fdd1f06b}",
    "{31ee4294-0d7c-4993-813f-2ca605226f39}",
    "{47cdba55-dcbc-4f40-8ea5-f00cff81ca55}",
    "{24eeef51-7e6a-46e6-8f01-fc23859cbfea}"
}

-- ===== DỊCH VỤ =====
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local VIM = game:GetService("VirtualInputManager")
local RunService = game:GetService("RunService")
local RS = game:GetService("ReplicatedStorage")

local LP = Players.LocalPlayer
local Character = LP.Character or LP.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local HRP = Character:WaitForChild("HumanoidRootPart")
local Backpack = LP:WaitForChild("Backpack")
local PlayerGui = LP:WaitForChild("PlayerGui")

local PetsService = RS:WaitForChild("GameEvents"):WaitForChild("PetsService")

local function waitx(t) task.wait(t or 0) end
local function nameMatch(toolName, keyword)
    return string.find(string.lower(toolName or ""), string.lower(keyword or ""), 1, true) ~= nil
end

local function equipTool(tool)
    pcall(function() Humanoid:EquipTool(tool) end)
    tool.Parent = Character
    waitx(0.05)
end

local function toolTryActivate(tool)
    if getgenv().CFG.TRY_ACTIVATE and tool and tool:IsA("Tool") then
        pcall(function() tool:Activate() end)
    end
    if getgenv().CFG.TRY_FIRE_REMOTE_CHILDREN and tool then
        for _,child in ipairs(tool:GetDescendants()) do
            if child.ClassName == "RemoteEvent" then
                local pos = HRP.Position + HRP.CFrame.LookVector * getgenv().CFG.CLICK_FORWARD_STUDS
                pcall(function() child:FireServer(pos) end)
            end
        end
    end
end

local function screenCenter()
    local cam = workspace.CurrentCamera
    local vp = cam.ViewportSize
    return vp.X/2, vp.Y/2
end

local function tryClickTap()
    if not getgenv().CFG.TRY_CLICK_TAP then return end
    local x, y = screenCenter()
    pcall(function()
        if UIS.TouchEnabled and not UIS.MouseEnabled then
            VIM:SendTouchEvent(x, y, 1, true); VIM:SendTouchEvent(x, y, 1, false)
        else
            VIM:SendMouseButtonEvent(x, y, 0, true, game, 0)
            VIM:SendMouseButtonEvent(x, y, 0, false, game, 0)
        end
    end)
end

-- ===== SIÊU NHANH: Thả tất cả pet khớp keyword
local function placeByKeywordFast(keyword, limitCount)
    local placed = 0
    for _,it in ipairs(Backpack:GetChildren()) do
        if it:IsA("Tool") and nameMatch(it.Name, keyword) then
            equipTool(it)
            toolTryActivate(it)
            tryClickTap()
            placed += 1
            if limitCount and placed >= limitCount then break end
        end
    end
    return placed
end

-- ===== THU PET THEO GUID =====
local function recallByGUIDs()
    for _,guid in ipairs(PET_GUIDS) do
        pcall(function()
            PetsService:FireServer("UnequipPet", guid)
        end)
        task.wait(0.06)
    end
end

-- ===== HUD MINI (TRICERATOPS TIMER) =====
local function createMiniTimer()
    local f = Instance.new("Frame")
    f.Size = UDim2.fromOffset(170, 74)
    f.Position = UDim2.fromOffset(16, 120)
    f.BackgroundColor3 = Color3.fromRGB(25,25,30)
    f.BorderSizePixel = 0
    local c = Instance.new("UICorner", f); c.CornerRadius = UDim.new(0,10)

    local title = Instance.new("TextLabel", f)
    title.BackgroundTransparency = 1
    title.Position = UDim2.fromOffset(8,6)
    title.Size = UDim2.new(1,-16,0,18)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 13
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextColor3 = Color3.fromRGB(210,210,210)
    title.Text = "Triceratops"

    local t = Instance.new("TextLabel", f)
    t.BackgroundTransparency = 1
    t.Position = UDim2.fromOffset(8,26)
    t.Size = UDim2.new(1,-16,0,26)
    t.Font = Enum.Font.GothamBlack
    t.TextSize = 22
    t.TextXAlignment = Enum.TextXAlignment.Left
    t.TextColor3 = Color3.fromRGB(255,255,255)
    t.Text = "--:--"

    local status = Instance.new("TextLabel", f)
    status.BackgroundTransparency = 1
    status.Position = UDim2.fromOffset(8,50)
    status.Size = UDim2.new(1,-16,0,18)
    status.Font = Enum.Font.Gotham
    status.TextSize = 12
    status.TextXAlignment = Enum.TextXAlignment.Left
    status.TextColor3 = Color3.fromRGB(200,200,200)
    status.Text = "IDLE"

    return f, t, status
end

local sg = Instance.new("ScreenGui", PlayerGui)
sg.Name = "TriPetTimerUI"
sg.ResetOnSpawn = false

local triFrame, triLabel, statusLabel = createMiniTimer()
triFrame.Parent = sg

local function fmt(sec)
    if sec<=0 then return "READY" end
    local m = math.floor(sec/60)
    local s = sec%60
    return string.format("%02d:%02d", m, s)
end

local triDeadline

-- Live update HUD
RunService.RenderStepped:Connect(function()
    triLabel.Text = triDeadline and fmt(triDeadline - time()) or "--:--"
end)

-- ===== UI NÚT =====
local dock = Instance.new("Frame", sg)
dock.AnchorPoint = Vector2.new(1,1)
dock.Position = UDim2.new(1, -16, 1, -120)
dock.Size = UDim2.fromOffset(200, 160)
dock.BackgroundColor3 = Color3.fromRGB(28,28,33)
Instance.new("UICorner", dock).CornerRadius = UDim.new(0,14)

local vlist = Instance.new("UIListLayout", dock)
vlist.Padding = UDim.new(0,8)
vlist.HorizontalAlignment = Enum.HorizontalAlignment.Center
vlist.VerticalAlignment = Enum.VerticalAlignment.Center

local function mkBtn(txt, color, height)
    local b = Instance.new("TextButton")
    b.Size = UDim2.new(1,-16,0,height or 36)
    b.Text = txt
    b.Font = Enum.Font.GothamBold
    b.TextSize = 16
    b.TextColor3 = Color3.fromRGB(255,255,255)
    b.BackgroundColor3 = color or Color3.fromRGB(60,120,255)
    Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
    b.Parent = dock
    return b
end

local btnAuto   = mkBtn("BẮT ĐẦU AUTO")
local btnPause  = mkBtn("DỪNG / TIẾP TỤC", Color3.fromRGB(255,170,60))
local btnDrop   = mkBtn("THẢ (Thủ công)")
local btnRecall = mkBtn("THU", Color3.fromRGB(245,90,90))

-- ===== TRẠNG THÁI AUTO =====
local autoEnabled = false
local paused = false
local loopThread

local function setStatus(s) statusLabel.Text = s end

local function startTriTimer()
    triDeadline = time() + getgenv().CFG.TRI_INTERVAL_SEC
end

-- 1 CHU KỲ: THU → THẢ TRI → chờ mốc để THẢ MOON → chờ TRI hết → cooldown 15s
local function doOneCycle()
    -- THU
    setStatus("THU pet...")
    recallByGUIDs()
    task.wait(0.3)

    -- THẢ TRICERATOPS
    setStatus("THẢ Triceratops...")
    local triPlaced = placeByKeywordFast(getgenv().CFG.TRI_KEYWORD, 1)
    if triPlaced <= 0 then
        setStatus("Không tìm thấy Tri trong Backpack")
        triDeadline = nil
        return
    end
    startTriTimer()
    setStatus("Đang đếm giờ...")

    -- ĐỢI MỐC để THẢ MOON
    local moonDropped = false
    while triDeadline and (triDeadline - time()) > 0 do
        if paused then
            setStatus("ĐÃ DỪNG (PAUSE)")
            repeat task.wait(0.1) until not paused
            setStatus("TIẾP TỤC")
        end

        local left = triDeadline - time()
        if (not moonDropped) and left <= getgenv().CFG.START_MOON_AT_LEFT then
            setStatus("THẢ Moon Cat...")
            placeByKeywordFast(getgenv().CFG.MOON_KEYWORD, getgenv().CFG.MAX_MOON_TO_PLACE)
            moonDropped = true
        end
        task.wait(0.05)
    end

    -- HẾT GIỜ → COOLDOWN 15s
    setStatus("Hết giờ → chờ ".. tostring(getgenv().CFG.LOOP_COOLDOWN_SEC) .."s")
    triDeadline = nil
    local t0 = time()
    while time() - t0 < getgenv().CFG.LOOP_COOLDOWN_SEC do
        if paused then
            setStatus("ĐÃ DỪNG (PAUSE)")
            repeat task.wait(0.1) until not paused
            setStatus("TIẾP TỤC")
            -- tiếp tục nốt phần cooldown
        end
        task.wait(0.1)
    end
end

-- VÒNG LẶP AUTO
local function runLoop()
    while autoEnabled do
        doOneCycle()
        if not autoEnabled then break end
    end
    setStatus("IDLE")
end

-- ===== NÚT HÀNH ĐỘNG =====
btnAuto.MouseButton1Click:Connect(function()
    if autoEnabled then
        -- tắt auto
        autoEnabled = false
        btnAuto.Text = "BẮT ĐẦU AUTO"
        setStatus("IDLE")
        return
    end
    -- bật auto
    autoEnabled = true
    paused = false
    btnAuto.Text = "ĐANG CHẠY AUTO..."
    setStatus("BẮT ĐẦU AUTO")
    if loopThread and coroutine.status(loopThread) ~= "dead" then
        -- đã có vòng trước, bỏ
    end
    loopThread = task.spawn(runLoop)
end)

btnPause.MouseButton1Click:Connect(function()
    if not autoEnabled then
        setStatus("AUTO chưa bật")
        return
    end
    paused = not paused
    btnPause.Text = paused and "ĐANG DỪNG (Nhấn để TIẾP TỤC)" or "DỪNG / TIẾP TỤC"
    setStatus(paused and "ĐÃ DỪNG (PAUSE)" or "TIẾP TỤC")
end)

-- Thả/Thu thủ công vẫn giữ
btnDrop.MouseButton1Click:Connect(function()
    if autoEnabled then return end
    setStatus("THẢ Tri + Moon (thủ công)")
    local triPlaced = placeByKeywordFast(getgenv().CFG.TRI_KEYWORD, 1)
    if triPlaced > 0 then
        triDeadline = time() + getgenv().CFG.TRI_INTERVAL_SEC
    end
    task.spawn(function()
        -- thả Moon ở mốc
        while triDeadline and (triDeadline - time()) > 0 do
            local left = triDeadline - time()
            if left <= getgenv().CFG.START_MOON_AT_LEFT then
                placeByKeywordFast(getgenv().CFG.MOON_KEYWORD, getgenv().CFG.MAX_MOON_TO_PLACE)
                break
            end
            task.wait(0.05)
        end
        setStatus("IDLE")
    end)
end)

btnRecall.MouseButton1Click:Connect(function()
    if autoEnabled then return end
    recallByGUIDs()
    triDeadline = nil
    setStatus("IDLE")
end)

print("[TriTimer] AUTO LOOP ready – Recall → Drop → Wait 15s → Repeat. Có PAUSE/RESUME.")
