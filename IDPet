-- 🧩 UNEQUIP → AUTO COPY + DANH SÁCH GUID (8 dòng + cuộn + X đóng + copy tất cả)

local Players = game:GetService("Players")
local RS      = game:GetService("ReplicatedStorage")
local SG      = game:GetService("StarterGui")
local LP      = Players.LocalPlayer
local PetsService = RS:WaitForChild("GameEvents"):WaitForChild("PetsService")

-- ========= tiện ích =========
local function safeClipboard(s)
    if typeof(s) ~= "string" then s = tostring(s) end
    if setclipboard then setclipboard(s)
    elseif toclipboard then toclipboard(s)
    else warn("[GUID] Executor không hỗ trợ clipboard") end
end

local function toast(t1, t2, dur)
    pcall(function()
        SG:SetCore("SendNotification", { Title = t1 or "Pet GUID", Text = t2 or "", Duration = dur or 3 })
    end)
end

local function cleanGuid(s) return (tostring(s):gsub("[{}]", "")) end

-- ========= GUI =========
local gui = Instance.new("ScreenGui")
gui.Name = "GUIDListSniffer"
gui.ResetOnSpawn = false
gui.Parent = LP:WaitForChild("PlayerGui")

-- ~ 8 dòng * 28px + padding + header ≈ 320px
local root = Instance.new("Frame")
root.Size = UDim2.fromOffset(380, 320)
root.Position = UDim2.new(0, 10, 1, -330)
root.BackgroundColor3 = Color3.fromRGB(24,24,24)
root.BackgroundTransparency = 0.15
root.BorderSizePixel = 0
root.Parent = gui
Instance.new("UICorner", root).CornerRadius = UDim.new(0,10)

local header = Instance.new("TextLabel")
header.BackgroundTransparency = 1
header.Size = UDim2.new(1, -90, 0, 26) -- chừa nút
header.Position = UDim2.new(0, 8, 0, 6)
header.Font = Enum.Font.GothamBold
header.TextSize = 14
header.TextXAlignment = Enum.TextXAlignment.Left
header.TextColor3 = Color3.fromRGB(255,255,255)
header.Text = "Unequip GUID (ấn vào dòng để copy lại)"
header.Parent = root

-- nút X đóng
local btnClose = Instance.new("TextButton")
btnClose.Size = UDim2.fromOffset(24, 24)
btnClose.Position = UDim2.new(1, -30, 0, 6)
btnClose.BackgroundColor3 = Color3.fromRGB(60,60,60)
btnClose.TextColor3 = Color3.new(1,1,1)
btnClose.Font = Enum.Font.GothamBold
btnClose.TextSize = 14
btnClose.Text = "X"
btnClose.Parent = root
Instance.new("UICorner", btnClose).CornerRadius = UDim.new(0,6)
btnClose.MouseButton1Click:Connect(function()
    gui:Destroy()
    toast("Đã đóng bảng GUID", "", 2)
end)

-- nút copy tất cả
local btnCopyAll = Instance.new("TextButton")
btnCopyAll.Size = UDim2.fromOffset(80, 24)
btnCopyAll.Position = UDim2.new(1, -120, 0, 6)
btnCopyAll.BackgroundColor3 = Color3.fromRGB(35,122,255)
btnCopyAll.TextColor3 = Color3.new(1,1,1)
btnCopyAll.Font = Enum.Font.GothamSemibold
btnCopyAll.TextSize = 12
btnCopyAll.Text = "Copy all"
btnCopyAll.Parent = root
Instance.new("UICorner", btnCopyAll).CornerRadius = UDim.new(0,6)

-- danh sách GUID
local sc = Instance.new("ScrollingFrame")
sc.Size = UDim2.new(1, -16, 1, -46)
sc.Position = UDim2.new(0, 8, 0, 38)
sc.BackgroundTransparency = 1
sc.BorderSizePixel = 0
sc.ScrollBarThickness = 6
sc.CanvasSize = UDim2.new(0,0,0,0)
sc.Parent = root

local layout = Instance.new("UIListLayout")
layout.FillDirection = Enum.FillDirection.Vertical
layout.HorizontalAlignment = Enum.HorizontalAlignment.Left
layout.SortOrder = Enum.SortOrder.LayoutOrder
layout.Padding = UDim.new(0, 7)
layout.Parent = sc

-- lưu danh sách GUID
local guidList = {}

local function addRow(guidStr)
    table.insert(guidList, guidStr)

    local row = Instance.new("TextButton")
    row.AutoButtonColor = true
    row.Size = UDim2.new(1, -6, 0, 28)
    row.BackgroundColor3 = Color3.fromRGB(32,32,32)
    row.BorderSizePixel = 0
    row.TextColor3 = Color3.fromRGB(220,220,220)
    row.Font = Enum.Font.Code
    row.TextSize = 12
    row.TextXAlignment = Enum.TextXAlignment.Left
    row.Text = "  " .. guidStr
    row.Parent = sc
    Instance.new("UICorner", row).CornerRadius = UDim.new(0,6)

    row.MouseButton1Click:Connect(function()
        safeClipboard(guidStr)
        toast("Đã copy GUID", guidStr, 2)
    end)

    -- cập nhật canvas
    task.defer(function()
        sc.CanvasSize = UDim2.new(0,0,0, layout.AbsoluteContentSize.Y + 8)
        if layout.AbsoluteContentSize.Y > sc.AbsoluteWindowSize.Y then
            sc.CanvasPosition = Vector2.new(0, layout.AbsoluteContentSize.Y - sc.AbsoluteWindowSize.Y)
        end
    end)
end

-- nút copy tất cả hoạt động
btnCopyAll.MouseButton1Click:Connect(function()
    if #guidList == 0 then
        toast("Chưa có GUID", "", 2)
        return
    end
    local allText = table.concat(guidList, "\n")
    safeClipboard(allText)
    toast("Đã copy tất cả GUID", "", 2)
end)

-- ========= HOOK =========
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", newcclosure(function(self, ...)
    local method = getnamecallmethod()
    local args = { ... }

    if self == PetsService and method == "FireServer" and not checkcaller() then
        if args[1] == "UnequipPet" and typeof(args[2]) == "string" then
            local guid = cleanGuid(args[2])
            safeClipboard(guid)
            toast("Đã copy GUID", guid, 2)
            addRow(guid)
            print("[GUID] UnequipPet -> "..guid)
        end
    end

    return oldNamecall(self, ...)
end))

toast("GUID list bật", "Thu pet sẽ auto copy + thêm vào danh sách", 4)
