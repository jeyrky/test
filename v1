-- ✅ GUI Auto PET nâng cấp: Cập nhật trạng thái các nút rõ ràng

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

local petName = "Tung Tung Tung Sahur"
local holdTime = 4
local followDistance = 1.2
local checkInterval = 0.2

local startPos, endPos = nil, nil
local autoRunning = false

-- UI
local screenGui = Instance.new("ScreenGui", game.CoreGui)
screenGui.Name = "AutoPET_GUI"

local function createButton(text, posY)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0, 220, 0, 40)
	btn.Position = UDim2.new(0, 10, 0, posY)
	btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.Text = text
	btn.Parent = screenGui
	btn.Font = Enum.Font.SourceSansBold
	btn.TextSize = 20
	btn.BorderSizePixel = 0
	return btn
end

local startBtn = createButton("▶️ Bắt đầu", 100)
local setStartBtn = createButton("📍 Lưu tọa độ đầu", 150)
local setEndBtn = createButton("📍 Lưu tọa độ cuối", 200)

-- Giữ E
local function holdEOnPet(pet)
	local root = pet.root
	local model = pet.model
	if not root or not model:IsDescendantOf(workspace) then return end
	if model:FindFirstChild("Owner") or model:FindFirstChild("NameGui") then return end

	local cash = lp:FindFirstChild("leaderstats") and lp.leaderstats:FindFirstChild("Cash")
	if not cash then return end

	local cashBefore = cash.Value
	keypress(0x45)
	local start = tick()
	local followConn = RunService.RenderStepped:Connect(function()
		if (hrp.Position - root.Position).Magnitude > followDistance then
			humanoid:MoveTo(Vector3.new(root.Position.X, hrp.Position.Y, root.Position.Z))
		else
			humanoid:MoveTo(hrp.Position)
		end
	end)

	while tick() - start < holdTime do
		if not model:IsDescendantOf(workspace) then break end
		wait(0.1)
	end

	keyrelease(0x45)
	if followConn then followConn:Disconnect() end

	local cashAfter = cash.Value
	if cashAfter < cashBefore then
		print("✅ MUA PET thành công.")
	else
		print("❌ Không mua được.")
	end
end

-- Kiểm tra PET trong vùng
local function isInZone(pos)
	if not startPos or not endPos then return false end
	local minX, maxX = math.min(startPos.X, endPos.X), math.max(startPos.X, endPos.X)
	local minZ, maxZ = math.min(startPos.Z, endPos.Z), math.max(startPos.Z, endPos.Z)
	return pos.X >= minX and pos.X <= maxX and pos.Z >= minZ and pos.Z <= maxZ
end

-- Tìm PET hợp lệ
local function findClosestPet()
	local nearest, nearestDist = nil, math.huge
	for _, label in ipairs(workspace:GetDescendants()) do
		if label:IsA("TextLabel") and label.Text == petName then
			local model = label:FindFirstAncestorOfClass("Model")
			local root = model and model:FindFirstChildWhichIsA("BasePart")
			if root and model:IsDescendantOf(workspace) and isInZone(root.Position) then
				local dist = (hrp.Position - root.Position).Magnitude
				if dist < nearestDist then
					nearest = { model = model, root = root }
					nearestDist = dist
				end
			end
		end
	end
	return nearest
end

-- Auto loop
task.spawn(function()
	while true do
		wait(checkInterval)
		if autoRunning and startPos and endPos then
			local pet = findClosestPet()
			if pet then
				holdEOnPet(pet)
			end
		end
	end
end)

-- Nút bấm
setStartBtn.MouseButton1Click:Connect(function()
	startPos = hrp.Position
	setStartBtn.Text = "✅ Đã lưu tọa độ đầu"
end)

setEndBtn.MouseButton1Click:Connect(function()
	endPos = hrp.Position
	setEndBtn.Text = "✅ Đã lưu tọa độ cuối"
end)

startBtn.MouseButton1Click:Connect(function()
	if startPos and endPos then
		autoRunning = not autoRunning
		startBtn.Text = autoRunning and "⏹ Đang chạy..." or "▶️ Bắt đầu"
		print(autoRunning and "✅ Auto đang chạy..." or "⏹ Đã tắt auto.")
	else
		warn("⚠️ Cần lưu cả tọa độ đầu và cuối trước.")
	end
end)
