--[[ 
    MASTER CONTROLLER SCRIPT (SMART MODE)
    Updated: Robust Signal Sending (Loop every 5s)
]]

if not game:IsLoaded() then game.Loaded:Wait() end

-- [FIX] Wait for PlayerGui (Load UI chọn phe)
local Players = game:GetService("Players")
repeat task.wait() until Players.LocalPlayer
local LP = Players.LocalPlayer
repeat task.wait() until LP:FindFirstChild("PlayerGui")
-- Chờ UI con load xong
local pg = LP.PlayerGui
repeat task.wait() until #pg:GetChildren() > 0

-- [FIX] Chờ thêm 5s để bảng chọn phe hiện rõ
task.wait(5)
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- Hàm log an toàn hiển thị lên Console Executor
local function log(msg)
    pcall(function()
        print(msg)
        if rconsoleprint then
            rconsoleprint(msg .. "\n")
        end
    end)
end

log("--- MASTER CONTROLLER STARTED (ROBUST SIGNAL VERSION) ---")

--------------------------------------------------------------------------------
-- 1. AUTO TEAM JOIN
--------------------------------------------------------------------------------
local function autoChooseTeam()
    local teamName = "Pirates"
    local commF = ReplicatedStorage:FindFirstChild("Remotes") and ReplicatedStorage.Remotes:FindFirstChild("CommF_")
    if commF and commF:IsA("RemoteFunction") then
        pcall(function() commF:InvokeServer("SetTeam", teamName) end)
    end
    task.wait(1)
    if LP.Team == nil then
        local function click(btn)
            if not btn then return end
            local vim = game:GetService("VirtualInputManager")
            local pos = btn.AbsolutePosition + (btn.AbsoluteSize/2)
            vim:SendMouseButtonEvent(pos.X, pos.Y, 0, true, btn, 0)
            vim:SendMouseButtonEvent(pos.X, pos.Y, 0, false, btn, 0)
        end
        for _, v in ipairs(game:GetService("CoreGui"):GetDescendants()) do
            if (v:IsA("TextButton") or v:IsA("ImageButton")) and (v.Name:lower():find("pirate") or (v.Text and v.Text:lower():find("pirate"))) then
                click(v) break
            end
        end
        for _, v in ipairs(LP.PlayerGui:GetDescendants()) do
             if (v:IsA("TextButton") or v:IsA("ImageButton")) and (v.Name:lower():find("pirate") or (v.Text and v.Text:lower():find("pirate"))) then
                click(v) break
            end
        end
    end
end

local t0 = os.clock()
while LP.Team == nil and os.clock() - t0 < 20 do
    autoChooseTeam()
    task.wait(1)
end

--------------------------------------------------------------------------------
-- 2. SMART SERVER HOP LOGIC (BLOCK REJOIN)
--------------------------------------------------------------------------------
local VISITED_FILE = "chest_visited.json"
local function loadVisited()
    local list = {}
    local s, content = pcall(readfile, VISITED_FILE)
    if s and content then
        local s2, decoded = pcall(HttpService.JSONDecode, HttpService, content)
        if s2 and decoded then list = decoded end
    end
    return list
end

local function saveVisited(jobId)
    local list = loadVisited()
    for _, id in ipairs(list) do
        if id == jobId then return end
    end
    table.insert(list, jobId)
    pcall(writefile, VISITED_FILE, HttpService:JSONEncode(list))
end

saveVisited(game.JobId) -- Block current server

local function smartHop()
    log("Đang tìm server ít người & khác server cũ...")
    local visited = loadVisited()
    local visitedSet = {}
    for _, id in ipairs(visited) do visitedSet[id] = true end
    
    local req = (syn and syn.request) or http_request or request
    local cursor = ""
    local found = nil
    
    if req then
        for i = 1, 10 do
            local url = "https://games.roblox.com/v1/games/" .. tostring(game.PlaceId) .. "/servers/Public?sortOrder=Asc&limit=100&cursor=" .. cursor
            local ok, res = pcall(function() return req({Url = url, Method = "GET"}) end)
            
            if ok and res and res.Body then
                local data = HttpService:JSONDecode(res.Body)
                if data and data.data then
                    for _, server in ipairs(data.data) do
                        local playing = server.playing or 0
                        local maxPlayers = server.maxPlayers or 0
                        -- Chọn server < 12 người VÀ chưa từng vào
                        if server.id ~= game.JobId and playing < 12 and not visitedSet[server.id] then
                            found = server.id
                            break
                        end
                    end
                end
                if found then break end
                if data.nextPageCursor then cursor = data.nextPageCursor else break end
            end
            task.wait(0.1)
        end
    end
    
    if found then
        log("-> Tìm thấy server ngon: " .. found)
        saveVisited(found)
        TeleportService:TeleportToPlaceInstance(game.PlaceId, found, LP)
    else
        log("-> Không tìm thấy server < 12 người. Random Teleport...")
        TeleportService:Teleport(game.PlaceId, LP)
    end
end

--------------------------------------------------------------------------------
-- 3. MAIN LOGIC (ROBUST SIGNAL INTEGRATION)
--------------------------------------------------------------------------------
task.spawn(function()
    -- 1. Wait for Data
    local waitData = 0
    repeat 
        task.wait(1)
        waitData = waitData + 1
        if waitData % 5 == 0 then log("Đang tải dữ liệu người chơi...") end
    until (LP:FindFirstChild("Data") and LP.Data:FindFirstChild("Level") and LP.Data:FindFirstChild("Beli") and LP.Data.Level.Value > 0) or waitData > 60

    -- 2. Helpers
    local function getPkgName()
        local pkg = "unknown"
        pcall(function()
            if isfile and isfile("appStorage.json") then
                local content = readfile("appStorage.json")
                if content and #content > 0 then
                    local js = HttpService:JSONDecode(content)
                    if js.PkgName then pkg = js.PkgName end
                end
            end
        end)
        return pkg
    end
    
    local pkgName = getPkgName()
    log("Package Name: " .. pkgName)

    local function updateStatus(msg, timeout)
        pcall(function()
            local g = LP.PlayerGui:FindFirstChild("JeyrkyDashboard")
            -- [AUTO-UPDATE] Nếu thấy bản cũ (Chiều cao < 90) thì xóa đi tạo lại
            if g and g:FindFirstChild("MainFrame") and g.MainFrame.Size.Y.Offset < 90 then
                g:Destroy()
                g = nil
            end

            if not g then
                g = Instance.new("ScreenGui")
                g.Name = "JeyrkyDashboard"
                g.Parent = LP.PlayerGui
                g.ResetOnSpawn = false

                -- Main Frame chứa tất cả
                local f = Instance.new("Frame", g)
                f.Name = "MainFrame"
                f.Size = UDim2.new(0, 450, 0, 115) -- [ADJUST] Tăng chiều cao lên 115 để chứa thêm dòng Random
                f.Position = UDim2.new(0.5, -225, 0.15, 0)
                f.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
                f.BackgroundTransparency = 0.2
                f.BorderSizePixel = 0
                f.ZIndex = 1
                
                local corner = Instance.new("UICorner", f)
                corner.CornerRadius = UDim.new(0, 10)
                
                local stroke = Instance.new("UIStroke", f)
                stroke.Color = Color3.fromRGB(255, 215, 0) -- Viền Vàng
                stroke.Thickness = 2
                stroke.Transparency = 0.5
                
                -- Layout: Xếp chồng dọc
                local layout = Instance.new("UIListLayout", f)
                layout.SortOrder = Enum.SortOrder.LayoutOrder
                layout.Padding = UDim.new(0, 2)
                layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
                layout.VerticalAlignment = Enum.VerticalAlignment.Center

                -- Spacer Top
                local spacer = Instance.new("Frame", f)
                spacer.Name = "Spacer"
                spacer.LayoutOrder = 0
                spacer.Size = UDim2.new(1, 0, 0, 5) -- Spacer 5px
                spacer.BackgroundTransparency = 1

                -- Dòng 1: LOGO (Cao nhất)
                local l1 = Instance.new("TextLabel", f)
                l1.Name = "Line1_Logo"
                l1.LayoutOrder = 1
                l1.Size = UDim2.new(1, 0, 0, 25)
                l1.BackgroundTransparency = 1
                l1.TextColor3 = Color3.fromRGB(255, 215, 0)
                l1.Font = Enum.Font.GothamBlack
                l1.TextSize = 18
                l1.Text = "JEYRKY TOOL"
                l1.ZIndex = 2
                
                -- Dòng 2: INFO (Beli - Nằm giữa)
                local l2 = Instance.new("TextLabel", f)
                l2.Name = "Line2_Info"
                l2.LayoutOrder = 2
                l2.Size = UDim2.new(1, 0, 0, 20)
                l2.BackgroundTransparency = 1
                l2.TextColor3 = Color3.fromRGB(255, 255, 255)
                l2.Font = Enum.Font.GothamBold
                l2.TextSize = 14
                l2.Text = "Loading Info..."
                l2.ZIndex = 2

                -- Dòng 3: RANDOM CHECK (MỚI)
                local lRandom = Instance.new("TextLabel", f)
                lRandom.Name = "Line_Random"
                lRandom.LayoutOrder = 3
                lRandom.Size = UDim2.new(1, 0, 0, 20)
                lRandom.BackgroundTransparency = 1
                lRandom.TextColor3 = Color3.fromRGB(200, 200, 200)
                lRandom.Font = Enum.Font.GothamBold
                lRandom.TextSize = 13
                lRandom.Text = "Check Random..."
                lRandom.ZIndex = 2

                -- Dòng 4: STATUS (Nằm dưới cùng)
                local l3 = Instance.new("TextLabel", f)
                l3.Name = "Line3_Status"
                l3.LayoutOrder = 4
                l3.Size = UDim2.new(1, 0, 0, 20)
                l3.BackgroundTransparency = 1
                l3.TextColor3 = Color3.fromRGB(0, 255, 255)
                l3.Font = Enum.Font.Gotham
                l3.TextSize = 13
                l3.Text = "Waiting..."
                l3.ZIndex = 2

                -- Progress Bar
                local barBg = Instance.new("Frame", f)
                barBg.Name = "BarBG"
                barBg.LayoutOrder = 5
                barBg.Size = UDim2.new(0.9, 0, 0, 4)
                barBg.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
                barBg.BorderSizePixel = 0
                local barCorner = Instance.new("UICorner", barBg)
                barCorner.CornerRadius = UDim.new(0, 4)

                local bar = Instance.new("Frame", barBg)
                bar.Name = "Bar"
                bar.Size = UDim2.new(0, 0, 1, 0)
                bar.BackgroundColor3 = Color3.fromRGB(0, 255, 255)
                bar.BorderSizePixel = 0
                local barCorner2 = Instance.new("UICorner", bar)
                barCorner2.CornerRadius = UDim.new(0, 4)
            end
            
            local f = g:FindFirstChild("MainFrame")
            if f then
                local l3 = f:FindFirstChild("Line3_Status")
                if l3 then l3.Text = msg end
                
                if timeout and timeout > 0 then
                    task.spawn(function()
                        local bar = f:FindFirstChild("BarBG") and f.BarBG:FindFirstChild("Bar")
                        if bar then
                            local startTime = os.clock()
                            while os.clock() - startTime < timeout do
                                local progress = 1 - ((os.clock() - startTime) / timeout)
                                bar.Size = UDim2.new(progress, 0, 1, 0)
                                task.wait(0.05)
                            end
                            bar.Size = UDim2.new(0, 0, 1, 0)
                        end
                    end)
                end
            end
        end)
    end
    
    local function isKicked()
        local ok, res = pcall(function()
            if not game.Players.LocalPlayer or not game.Players.LocalPlayer.Parent then
                return true
            end
            local coreGui = game:GetService("CoreGui")
            local promptGui = coreGui:FindFirstChild("RobloxPromptGui")
            if not promptGui then return false end
            local kws = {"kick","disconnect","security","banned","mất kết nối","mã lỗi","error code","please rejoin","not authorized","maintenance","bảo trì","internet","connection","same account","launch","idle","chặn","restricted","đóng","close","rời khỏi","leave","kết nối lại","reconnect","277","267","268"}
            for _, d in ipairs(promptGui:GetDescendants()) do
                if (d:IsA("TextLabel") or d:IsA("TextButton")) and d.Visible then
                    local t = string.lower(d.Text or "")
                    for _, k in ipairs(kws) do
                        if string.find(t, k) then
                            return true
                        end
                    end
                end
            end
            return false
        end)
        if ok then return res end
        return false
    end
    
    local VirtualUser = game:GetService("VirtualUser")
    game.Players.LocalPlayer.Idled:Connect(function()
        pcall(function()
            VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera and workspace.CurrentCamera.CFrame or CFrame.new())
            task.wait(1)
            VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera and workspace.CurrentCamera.CFrame or CFrame.new())
        end)
    end)
    
    task.spawn(function()
        while true do
            if isKicked() then
                updateStatus("KICKED", 5)
                sendSignal("HeartbeatKicked")
            else
                sendSignal("HeartbeatOnline")
            end
            task.wait(20)
        end
    end)

    local function sendSignal(signalName)
        log(">>> [SIGNAL] Đang gửi tín hiệu: " .. signalName)
        
        -- GUI UPDATE
        updateStatus("SENDING: " .. signalName .. " (" .. os.time() .. ")")

        local body = HttpService:JSONEncode({
            package = pkgName,
            signal = signalName,
            nonce = tostring(math.random(100000, 999999))
        })
        
        local reqFunc = (syn and syn.request) or (http and http.request) or http_request or request or (fluxus and fluxus.request)
        
        -- Gửi song song (Parallel) để không bị block bởi timeout
        
        -- 1. POST (Executor) - Emulator
        task.spawn(function()
            if reqFunc then
                pcall(function()
                    reqFunc({
                        Url = "http://10.0.2.2:8000/signal",
                        Method = "POST",
                        Headers = {["Content-Type"] = "application/json"},
                        Body = body
                    })
                end)
            end
        end)

        -- 2. POST (Executor) - PC
        task.spawn(function()
            if reqFunc then
                pcall(function()
                    reqFunc({
                        Url = "http://127.0.0.1:8000/signal",
                        Method = "POST",
                        Headers = {["Content-Type"] = "application/json"},
                        Body = body
                    })
                end)
            end
        end)
            
        -- 3. POST (HttpService) - Parallel
        task.spawn(function()
             pcall(function()
                HttpService:RequestAsync({
                    Url = "http://127.0.0.1:8000/signal",
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = body
                })
            end)
        end)
        
        -- 4. FILE BACKUP (Always) - Ghi nhiều nơi
        log(">>> [BACKUP] Ghi file appStorage.json...")
        local js = {}
        pcall(function()
            if isfile and isfile("appStorage.json") then
                 local c = readfile("appStorage.json")
                 js = HttpService:JSONDecode(c)
            end
        end)
        js.PkgName = pkgName
        js.Signal = signalName
        js.Nonce = tostring(math.random(100000, 999999))
        js.Heartbeat = os.time()
        
        local content = HttpService:JSONEncode(js)
        pcall(function() writefile("appStorage.json", content) end)
        -- Thu ghi vao cac path khac neu co the
        pcall(function() writefile("../appStorage.json", content) end) 
    end
    
    -- *** LOOP SIGNAL SENDER ***
    -- Gửi tín hiệu lặp lại mỗi 5s cho đến khi game đóng (do Python xử lý)
    local isLooping = false
    local function startSignalLoop(signalName)
        if isLooping then return end -- Prevent double loops
        isLooping = true
        log(">>> [LOOP] Bắt đầu gửi liên tục tín hiệu: " .. signalName .. " (5s/lần)")
        
        -- Gửi ngay lập tức lần đầu tiên
        sendSignal(signalName)
        
        task.spawn(function()
            while true do
                task.wait(5)
                sendSignal(signalName)
            end
        end)
    end
    
    -- Gửi tín hiệu TEST (Đã tắt để tránh spam/confuse)
    -- task.spawn(function()
    --    log(">>> Kiểm tra kết nối Python...")
    --    task.wait(3)
    --    sendSignal("TestConnection_Start")
    -- end)

    -- EXPOSE GLOBAL FUNCTION FOR EXTERNAL SCRIPTS
    getgenv().SignalChangeAccount = function()
        log(">>> [GLOBAL CALL] External script requested ChangeAccount")
        startSignalLoop("ChangeAccount")
    end

    getgenv().SignalNotEnoughBeli = function()
        log(">>> [GLOBAL CALL] External script requested NotEnoughBeli")
        startSignalLoop("NotEnoughBeli")
    end

    -- 2b. Helpers for Persistent "Bought" State
    -- [FIX] Dùng tên người chơi để tách biệt trạng thái giữa các acc
    local LAST_ACTION_FILE = "last_action_" .. LP.Name .. ".txt"
    
    local function saveLastAction(action)
        pcall(writefile, LAST_ACTION_FILE, action .. "|" .. tostring(os.time()))
    end
    
    local function getLastAction()
        local action, ts = "NONE", 0
        pcall(function()
            if isfile(LAST_ACTION_FILE) then
                local content = readfile(LAST_ACTION_FILE)
                local a, t = content:match("^(.*)|(%d+)$")
                if a and t then
                    action = a
                    ts = tonumber(t) or 0
                end
            end
        end)
        return action, ts
    end

    local function getServerType()
        local st = "VIP1" -- Default fallback
        pcall(function()
            if isfile and isfile("appStorage.json") then
                local c = readfile("appStorage.json")
                local j = HttpService:JSONDecode(c)
                if j.ServerType then st = j.ServerType end
            end
        end)
        return st
    end

    local function getRandomPrice()
        local s, level = pcall(function() return LP.Data.Level.Value end)
        if not s or not level or level <= 0 then return 25000 end
        local cost = 25000 + (level - 1) * 150
        if LP.MembershipType == Enum.MembershipType.Premium then
            cost = math.floor(cost * 0.8)
        end
        return cost
    end

    local function detectBeliMultiplier()
        local mult = 1
        pcall(function()
            local pg = LP:FindFirstChild("PlayerGui")
            if not pg then return end
            for _, d in ipairs(pg:GetDescendants()) do
                if d:IsA("TextLabel") and d.Visible then
                    local t = string.lower(d.Text or "")
                    if (t:find("x3") or t:find("3x")) and (t:find("beli") or t:find("money")) then
                        mult = 3
                        break
                    elseif (t:find("x2") or t:find("2x")) and (t:find("beli") or t:find("money")) and mult < 3 then
                        mult = 2
                    end
                end
            end
        end)
        return mult
    end

    local function getEffectiveServerType()
        local st = getServerType()
        SERVER_TYPE = st
        return st
    end

    -- 3. Logic Branching
    local serverType = getEffectiveServerType()
    
    -- [DEBUG] In rõ nội dung file để kiểm tra
    task.spawn(function()
        pcall(function()
            if isfile and isfile("appStorage.json") then
                log("DEBUG appStorage: " .. readfile("appStorage.json"))
            else
                log("DEBUG appStorage: FILE NOT FOUND")
            end
        end)
    end)

    local curBeli = LP.Data.Beli.Value
    local cost = getRandomPrice()
    local targetCost = cost * 2

    log("---------------------------------------")
    log("SERVER TYPE: " .. serverType)
    log("BELI: " .. curBeli .. " | COST 1x: " .. cost .. " | TARGET 2x: " .. targetCost)
    log("---------------------------------------")

    local FARM_DONE = false
    local HOP_ONCE_DONE = false
    local HOP_TIMER_SECONDS = 120
    pcall(function()
        local g = getgenv and getgenv() or {}
        local v = g.FarmHopSeconds or g.BeliHopSeconds
        if type(v) == "number" and v > 0 then HOP_TIMER_SECONDS = v end
    end)

    -- GUI Tracker (Beli & Server Info) - Integrated into JeyrkyDashboard
    task.spawn(function()
        local function formatNumber(n)
            return tostring(n):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "")
        end

        while true do
            local c = getRandomPrice()
            local b = 0
            pcall(function() b = LP.Data.Beli.Value end)
            local diff = c - b
            local st = (diff <= 0) and "ĐỦ TIỀN" or ("Thiếu " .. formatNumber(diff))
            
            local multiplier = detectBeliMultiplier()
            local serverColor = (serverType == "VIP1") and "VIP 1 (Random)" or "VIP 2 (Farm)"
            if multiplier > 1 then
                serverColor = serverColor .. string.format(" | x%d Beli", multiplier)
            end
            local infoText = string.format("[%s] Beli: %s | Cần: %s | %s", serverColor, formatNumber(b), formatNumber(c), st)
            
            -- Update JeyrkyDashboard Line 2
            local g = LP.PlayerGui:FindFirstChild("JeyrkyDashboard")
            if not g then
                -- Recreate if missing (Force update status to trigger creation)
                updateStatus("Recreating UI...", 0)
                g = LP.PlayerGui:FindFirstChild("JeyrkyDashboard")
            end
            
            if g and g:FindFirstChild("MainFrame") then
                -- [ADDON] Force Visible if hidden
                g.Enabled = true
                g.MainFrame.Visible = true

                local l2 = g.MainFrame:FindFirstChild("Line2_Info")
                if l2 then
                    l2.Text = infoText
                    if diff <= 0 then
                        l2.TextColor3 = Color3.fromRGB(0, 255, 0) -- Green
                    else
                        l2.TextColor3 = Color3.fromRGB(255, 255, 255) -- White
                    end
                end

                -- [ADDON] Update Random Info (Line_Random)
                local lastAct, lastTime = getLastAction()
                local randomText
                local randomColor

                if lastAct == "BOUGHT" then
                    local cooldown = 7200
                    local timeSince = os.time() - lastTime
                    local remaining = cooldown - timeSince
                    if remaining > 0 then
                        local h = math.floor(remaining / 3600)
                        local m = math.floor((remaining % 3600) / 60)
                        local s = remaining % 60
                        randomText = string.format("Time: %02d:%02d:%02d", h, m, s)
                        randomColor = Color3.fromRGB(255, 100, 100)
                    else
                        if diff <= 0 then
                            randomText = "Time: Đủ thời gian"
                            randomColor = Color3.fromRGB(0, 255, 0)
                        else
                            randomText = string.format("Time: chờ thêm %s Beli mới có thể random", formatNumber(diff))
                            randomColor = Color3.fromRGB(255, 255, 0)
                        end
                    end
                else
                    if diff <= 0 then
                        randomText = "Time: Đủ thời gian"
                        randomColor = Color3.fromRGB(0, 255, 0)
                    else
                        randomText = string.format("Time: chờ thêm %s Beli mới có thể random", formatNumber(diff))
                        randomColor = Color3.fromRGB(255, 255, 0)
                    end
                end

                local lRandom = g.MainFrame:FindFirstChild("Line_Random")
                if lRandom then
                    lRandom.Text = randomText
                    lRandom.TextColor3 = randomColor
                end
            end
            
            task.wait(1)
        end
    end)

    if serverType == "VIP1" then
        -- MODE: RANDOM FRUIT
        if curBeli >= cost then
            log(">>> [VIP1] Đủ tiền -> Chạy Random Fruit...")
            saveLastAction("BOUGHT")
            updateStatus("Random")
            
            -- [UPDATED] Không tự gửi ChangeAccount nữa vì script Brain sẽ tự làm việc đó.
            -- Chỉ giữ lại logic lưu trạng thái "BOUGHT" nếu cần thiết (nhưng vì script Brain tự xử lý nên có thể bỏ qua hoặc để script Brain tự lo)
            
            -- Exec Script
            local success, err = pcall(function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/jeyrky/test/refs/heads/main/Brain"))()
            end)
            if not success then
                log("Lỗi load script Brain: " .. tostring(err))
                updateStatus("ERROR LOAD SCRIPT: " .. tostring(err), 5)
                -- Fallback: Nếu không load được script thì buộc phải tự next acc
                task.wait(5)
                startSignalLoop("ChangeAccount") 
            end
        else
            -- Check "Bought" History
            local lastAct, lastTime = getLastAction()
            if lastAct == "BOUGHT" and (os.time() - lastTime) < 300 then
                log(">>> [VIP1] Phát hiện vừa mua trái (History < 5p) -> Gửi lại ChangeAccount")
                startSignalLoop("ChangeAccount")
            else
                log(">>> [VIP1] Thiếu tiền (Có: " .. curBeli .. " | Cần: " .. cost .. ") -> Gửi tín hiệu NotEnoughBeli")
                
                -- [DEBUG] Test writefile trực tiếp để xem có lỗi permission không
                pcall(function()
                    writefile("debug_signal_test.txt", "Test write from NotEnoughBeli logic at " .. tostring(os.time()))
                    log(">>> [DEBUG] Write debug file OK")
                end)
    
                startSignalLoop("NotEnoughBeli") -- Loop signal
            end
        end

    elseif serverType == "VIP2" then
        -- MODE: FARM BELI (MỤC TIÊU: ĐỦ TIỀN CHO 2 LẦN RANDOM)
        if curBeli >= targetCost then
            log(">>> [VIP2] Đã đủ tiền x2 Beli -> Gửi tín hiệu về VIP1 Random (LOOP 5s)")
            startSignalLoop("EnoughBeliFarmDone") -- Loop signal
        else
            log(">>> [VIP2] Thiếu tiền -> Farm Chest...")
            
            -- Monitor money while farming
            task.spawn(function()
                while true do
                    task.wait(5)
                    if LP.Data.Beli.Value >= targetCost then
                        FARM_DONE = true
                        log(">>> [VIP2] Farm đủ x2 Beli! Signal về VIP1 (LOOP 5s)...")
                        updateStatus("Đủ Beli - Reset Account")
                        startSignalLoop("EnoughBeliFarmDone") -- Loop signal
                        break
                    end
                end
            end)
            task.spawn(function()
                local endTime = os.clock() + HOP_TIMER_SECONDS
                while os.clock() < endTime do
                    if FARM_DONE then return end
                    task.wait(1)
                end
                if not FARM_DONE and not HOP_ONCE_DONE then
                    HOP_ONCE_DONE = true
                    smartHop()
                end
            end)

            -- [NEW FEATURE] Check Beli Stuck (30s) -> Low User Server
            task.spawn(function()
                local lastBeli = 0
                pcall(function() lastBeli = LP.Data.Beli.Value end)
                local lastChange = os.clock()

                while true do
                    task.wait(1)
                    if FARM_DONE or HOP_ONCE_DONE then break end
                    
                    local cur = 0
                    local s = pcall(function() cur = LP.Data.Beli.Value end)
                    if s then
                        if cur ~= lastBeli then
                            lastBeli = cur
                            lastChange = os.clock()
                        else
                            -- Beli unchanged
                            if os.clock() - lastChange > 30 then
                                log(">>> [VIP2] Beli không tăng trong 30s -> Smart Hop (Low User)...")
                                if not FARM_DONE and not HOP_ONCE_DONE then
                                    HOP_ONCE_DONE = true
                                    smartHop()
                                end
                                break
                            end
                        end
                    end
                end
            end)

            -- Exec Farm Script
            -- Check server load for Smart Hop
            local pc = #game.Players:GetPlayers()
            -- [FIX] Tăng giới hạn người chơi lên 40 để tránh hop liên tục
            if pc > 40 then
                log(">>> [VIP2] Server quá đông (>40) -> Smart Hop tìm server vắng...")
                smartHop()
            else
                log(">>> [VIP2] Server ổn (<=40) -> Chạy Chest Script (SILENT MODE)")
                
                -- --- SILENT LOAD & HIDE UI LOGIC ---
                task.spawn(function()
                    -- 1. Chặn Notification
                    pcall(function()
                        local mt = getrawmetatable(game)
                        local old = mt.__namecall
                        if setreadonly then setreadonly(mt, false) end
                        mt.__namecall = newcclosure(function(self, ...)
                            local args = {...}
                            if getnamecallmethod() == "SetCore" and args[1] == "SendNotification" then
                                return -- Block Notification
                            end
                            return old(self, ...)
                        end)
                        if setreadonly then setreadonly(mt, true) end
                    end)

                    -- 2. Ẩn GUI (Trừ JeyrkyDashboard & System)
                    local function hideGui(g)
                        if g:IsA("ScreenGui") and g.Name ~= "JeyrkyDashboard" then
                            local sys = {"RobloxGui","TopBar","CoreScripts","PurchasePrompt","HeadsetDisconnectedDialog","TeleportGui","RobloxLoadingGui","Chat","BubbleChat","RbxCameraUI"}
                            for _,s in pairs(sys) do if g.Name == s then return end end
                            
                            g.Enabled = false
                            -- Hook để giữ trạng thái ẩn
                            local s, e = pcall(function() 
                                g:GetPropertyChangedSignal("Enabled"):Connect(function() 
                                    if g.Enabled then g.Enabled = false end 
                                end) 
                            end)
                            -- Ẩn các frame con
                            for _, c in pairs(g:GetChildren()) do
                                if c:IsA("Frame") or c:IsA("ScrollingFrame") or c:IsA("ImageLabel") then c.Visible = false end
                            end
                        end
                    end

                    -- [ADDON] Auto-Close "Reset Config" Popup
                    task.spawn(function()
                        while true do
                            task.wait(1)
                            pcall(function()
                                local CoreGui = game:GetService("CoreGui")
                                local PlayerGui = game:GetService("Players").LocalPlayer:FindFirstChild("PlayerGui")
                                
                                local function checkAndClose(parent)
                                    if not parent then return end
                                    for _, v in ipairs(parent:GetDescendants()) do
                                        if v:IsA("TextLabel") and (string.find(v.Text, "Yes Or No") or string.find(v.Text, "want reset Config")) then
                                            local g = v:FindFirstAncestorWhichIsA("ScreenGui")
                                            if g then
                                                -- Try to find "No" button
                                                for _, b in ipairs(g:GetDescendants()) do
                                                    if (b:IsA("TextButton") or b:IsA("ImageButton")) and (b.Name == "No" or (b:IsA("TextButton") and b.Text == "No")) then
                                                        -- Click No
                                                        local vim = game:GetService("VirtualInputManager")
                                                        local pos = b.AbsolutePosition + (b.AbsoluteSize/2)
                                                        vim:SendMouseButtonEvent(pos.X, pos.Y, 0, true, b, 0)
                                                        vim:SendMouseButtonEvent(pos.X, pos.Y, 0, false, b, 0)
                                                        task.wait(0.1)
                                                    end
                                                end
                                                g:Destroy()
                                            end
                                        end
                                    end
                                end
                                
                                checkAndClose(CoreGui)
                                checkAndClose(PlayerGui)
                            end)
                        end
                    end)

                    game:GetService("CoreGui").ChildAdded:Connect(hideGui)
                    local lp = game:GetService("Players").LocalPlayer
                    if lp then
                        local pg = lp:WaitForChild("PlayerGui", 5)
                        if pg then 
                            pg.ChildAdded:Connect(hideGui) 
                            for _,v in pairs(pg:GetChildren()) do hideGui(v) end
                        end
                    end
                end)

                -- 3. Load Script
                loadstring(game:HttpGet("https://raw.githubusercontent.com/trongdeptraihucscript/Main/refs/heads/main/TN-Tp-Chest.lua"))()
            end
        end
        
    else
        log(">>> [UNKNOWN MODE] ServerType không rõ: " .. tostring(serverType))
        -- Fallback: Chạy random như bình thường
        loadstring(game:HttpGet("https://raw.githubusercontent.com/jeyrky/test/refs/heads/main/Brain"))()
    end
end)

local HttpService = game:GetService("HttpService")
local BASE = "http://127.0.0.1:8000"

-- 1. Detect Request Function (Executor dependent)
local req = (syn and syn.request) or (http and http.request) or http_request or request

-- 2. Function to read Package Name and Server Type from appStorage.json
local SERVER_TYPE = "NORMAL"
local function readPkg()
    local ok, content = pcall(readfile, "appStorage.json")
    if ok and content then
        local ok2, js = pcall(HttpService.JSONDecode, HttpService, content)
        if ok2 and js then
             if js.ServerType then SERVER_TYPE = js.ServerType end
             if js.PkgName then return js.PkgName end
        end
    end
    return nil -- Let Python handle if unknown
end

local PKG = readPkg()

-- 2.1 Check Kick Status
local function isKicked()
    local success, result = pcall(function()
        -- [Check 0] Player Removed
        if not game.Players.LocalPlayer or not game.Players.LocalPlayer.Parent then
            return true
        end

        local coreGui = game:GetService("CoreGui")
        local promptGui = coreGui:FindFirstChild("RobloxPromptGui")
        if not promptGui then return false end
        
        -- [Enhanced Check] Scan toàn bộ RobloxPromptGui thay vì chỉ promptOverlay
        -- Vì đôi khi UI thay đổi cấu trúc
        local kick_keywords = {
            "kick", "disconnect", "security", "banned",
            "mất kết nối", "mã lỗi", "error code",
            "please rejoin", "not authorized", "maintenance",
            "bảo trì", "internet", "connection",
            "same account", "launch", "idle",
            "chặn", "restricted", "đóng", "close",
            "rời khỏi", "leave", "kết nối lại", "reconnect",
            "277", "267", "268" -- Các mã lỗi phổ biến
        }

        for _, descendant in pairs(promptGui:GetDescendants()) do
             if descendant:IsA("TextLabel") or descendant:IsA("TextButton") then
                if descendant.Visible then
                    local text = descendant.Text:lower()
                    for _, kw in ipairs(kick_keywords) do
                        if text:find(kw) then 
                            -- Log nhẹ để debug nếu cần (nhưng user k thấy console)
                            return true 
                        end
                    end
                end
             end
        end

        return false
    end)
    if success and result then return true end
    return false
end

-- 3. Main Heartbeat Function
local KICK_SENT = false

local function sendRequest(endpoint, data)
    local url = BASE .. endpoint
    local body = HttpService:JSONEncode(data)
    local headers = {["Content-Type"] = "application/json"}
    local success = false

    -- Method A: HttpService:RequestAsync (POST)
    if not success then
        pcall(function()
            local response = HttpService:RequestAsync({
                Url = url,
                Method = "POST",
                Headers = headers,
                Body = body
            })
            if response.StatusCode == 200 then success = true end
        end)
    end

    -- Method B: Executor Request (POST)
    if not success and req then
        pcall(function()
            local response = req({
                Url = url,
                Method = "POST",
                Headers = headers,
                Body = body
            })
            if response and response.StatusCode == 200 then success = true end
        end)
    end
    
    -- Method C: GET Fallback
    if not success then
        -- Convert data to query string roughly
        local query = ""
        for k,v in pairs(data) do
            query = query .. "&" .. k .. "=" .. tostring(v)
        end
        pcall(function()
            game:HttpGet(url .. "?" .. query)
        end)
    end
end

local function sendHeartbeat()
    -- Retry reading PKG if missing
    if not PKG then PKG = readPkg() end

    -- Check if kicked
    if isKicked() then
        if not KICK_SENT then
            print("DETECTED KICKED - SENDING SIGNAL TO SERVER...")
            sendRequest("/signal", {package = PKG, signal = "Kicked"})
            KICK_SENT = true
        else
            print("DETECTED KICKED - WAITING FOR RESTART...")
        end
        return
    end

    local username = "Unknown"
    pcall(function()
        if game:GetService("Players").LocalPlayer then
            username = game:GetService("Players").LocalPlayer.Name
        end
    end)
    
    if username ~= "Unknown" then
        print("Sending Heartbeat for: " .. username .. " | Type: " .. SERVER_TYPE)
    else
        print("Sending Heartbeat (Username not found yet)")
    end
    
    -- Gửi Heartbeat
    sendRequest("/heartbeat", {
        package = PKG, 
        username = username,
        server_type = SERVER_TYPE
    })

    -- Method D: AppStorage File Fallback (Keep this for redundancy)
    pcall(function()
        local js = {}
        local ok, content = pcall(readfile, "appStorage.json")
        if ok and content and #content > 0 then
            local ok2, data = pcall(HttpService.JSONDecode, HttpService, content)
            if ok2 and type(data) == "table" then js = data end
        end
        js.Heartbeat = os.time()
        js.username = username
        if PKG and not js.PkgName then js.PkgName = PKG end
        -- Preserve ServerType if exists
        if not js.ServerType then js.ServerType = SERVER_TYPE end
        writefile("appStorage.json", HttpService:JSONEncode(js))
    end)
end

-- 4. Auto-loop every 10 seconds
task.spawn(function()
    while true do
        sendHeartbeat()
        task.wait(10)
    end
end)

-- 5. Expose to global env for manual testing
getgenv().OnlineHeartbeat = {
    Heartbeat = sendHeartbeat
}

--[[
    Anti AFK Script
    Tự động tương tác để tránh bị Roblox kick sau 20 phút không hoạt động.
]]

local VirtualUser = game:GetService("VirtualUser")
local Players = game:GetService("Players")

-- Đợi LocalPlayer load xong
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
    repeat wait() until Players.LocalPlayer
    LocalPlayer = Players.LocalPlayer
end

print("--> Anti AFK Script đã được kích hoạt!")

-- Cách 1: Sử dụng Event Idled (Chuẩn nhất)
-- Khi Roblox phát hiện người dùng không hoạt động, event này sẽ kích hoạt.
-- Chúng ta sẽ giả lập một cú click chuột để reset timer.
LocalPlayer.Idled:Connect(function()
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new()) -- Click chuột phải ảo
        print("Anti AFK: Đã tự động tương tác để tránh bị kick.")
    end)
end)

-- Cách 2: Vòng lặp Backup (Đề phòng trường hợp Event không nổ)
-- Thực hiện click nhẹ mỗi 10 phút
spawn(function()
    while true do
        wait(600) -- 10 phút
        pcall(function()
            VirtualUser:CaptureController()
            VirtualUser:ClickButton2(Vector2.new())
        end)
    end
end)

-- Gửi thông báo nhỏ lên màn hình (nếu hỗ trợ)
pcall(function()
    game.StarterGui:SetCore("SendNotification", {
        Title = "Anti AFK";
        Text = "Đã bật chế độ treo máy!";
        Duration = 5;
    })
end)
