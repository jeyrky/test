-- ===========================
-- üîÅ REJOIN ƒê√öNG SERVER HI·ªÜN T·∫†I (PlaceId + JobId)
-- ===========================
local TS       = game:GetService("TeleportService")
local Players  = game:GetService("Players")
local CoreGui  = game:GetService("CoreGui")
local lp       = Players.LocalPlayer
local PLACE_ID = game.PlaceId
local JOB_ID   = game.JobId

local REJOINING   = false
local MAX_RETRIES = 5

local function rejoinSameServer()
    if REJOINING then return end
    REJOINING = true
    -- th·ª≠ nhi·ªÅu l·∫ßn ƒë·ªÅ ph√≤ng Teleport b·ªã fail t·∫°m th·ªùi
    for i = 1, MAX_RETRIES do
        local ok, err = pcall(function()
            TS:TeleportToPlaceInstance(PLACE_ID, JOB_ID, lp)
        end)
        if ok then
            return
        else
            warn(("[Rejoin] L·∫ßn %d/%d l·ªói: %s"):format(i, MAX_RETRIES, tostring(err)))
            task.wait(1 + i*0.5)
        end
    end
    REJOINING = false
end

-- ‚å®Ô∏è Ph√≠m n√≥ng: F5 ƒë·ªÉ rejoin ngay
do
    local VIM = game:GetService("VirtualInputManager")
    game:GetService("UserInputService").InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == Enum.KeyCode.F5 then
            rejoinSameServer()
        end
    end)
end

-- üñ±Ô∏è N√∫t Rejoin g√≥c ph·∫£i
do
    local sg = Instance.new("ScreenGui")
    sg.Name = "RejoinBtnGui"
    sg.ResetOnSpawn = false
    sg.IgnoreGuiInset = true
    sg.Parent = (gethui and gethui()) or CoreGui

    local btn = Instance.new("TextButton")
    btn.Name = "RejoinBtn"
    btn.Size = UDim2.fromOffset(110, 36)
    btn.Position = UDim2.new(1, -120, 1, -46)
    btn.AnchorPoint = Vector2.new(0,0)
    btn.BackgroundColor3 = Color3.fromRGB(25,25,25)
    btn.TextColor3 = Color3.fromRGB(255,255,255)
    btn.TextSize = 16
    btn.BorderSizePixel = 0
    btn.AutoButtonColor = true
    btn.Text = "‚ü≥ Rejoin (F5)"
    btn.Parent = sg

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = btn

    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 1
    stroke.Color = Color3.fromRGB(70,70,70)
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    stroke.Parent = btn

    btn.MouseButton1Click:Connect(rejoinSameServer)
end

-- ü§ñ Auto rejoin khi xu·∫•t hi·ªán ErrorPrompt (Disconnected/Kicked/Unexpected Error)
do
    local function tryHookPrompt(container)
        if not container then return end
        container.DescendantAdded:Connect(function(d)
            -- Roblox th∆∞·ªùng spawn "ErrorPrompt" ho·∫∑c TextLabel c√≥ ch·ªØ Disconnected/Kicked
            if typeof(d) == "Instance" then
                local name = d.Name:lower()
                if name:find("errorprompt") then
                    task.wait(0.5)
                    rejoinSameServer()
                elseif d:IsA("TextLabel") then
                    local txt = (d.Text or ""):lower()
                    if txt:find("disconnected") or txt:find("kicked") or txt:find("unexpected") then
                        task.wait(0.5)
                        rejoinSameServer()
                    end
                end
            end
        end)
    end

    -- hook ngay v√† c·∫£ khi RobloxPromptGui xu·∫•t hi·ªán tr·ªÖ
    local function hookNow()
        local prompt = CoreGui:FindFirstChild("RobloxPromptGui", true)
        if prompt then tryHookPrompt(prompt) end
    end
    hookNow()
    CoreGui.ChildAdded:Connect(function(ch)
        if ch.Name == "RobloxPromptGui" then
            task.wait(0.1)
            hookNow()
        end
    end)
end

-- üß™ Tu·ª≥ ch·ªçn: c≈©ng c√≥ th·ªÉ rejoin khi state Teleport report l·ªói
TS.TeleportInitFailed:Connect(function(player, result, placeId, spawnName)
    warn("[Rejoin] TeleportInitFailed:", result)
    task.wait(0.75)
    rejoinSameServer()
end)

print("[Rejoin] S·∫µn s√†ng. Nh·∫•n F5 ho·∫∑c b·∫•m n√∫t ‚ü≥ Rejoin ƒë·ªÉ v√†o l·∫°i ƒë√∫ng server hi·ªán t·∫°i.")
