local AppStorageService = game:GetService("AppStorageService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- CONFIG
local SERVER_URL = "http://127.0.0.1:8000"
local HEARTBEAT_INTERVAL = 15 -- Giây

-- State
local PkgName = ""

local function log(msg)
    print("[AUTO] " .. tostring(msg))
end

-- Hàm gửi request an toàn
local function sendRequest(endpoint, data)
    if PkgName == "" then return end
    local body = HttpService:JSONEncode(data)
    local ok, res = pcall(function()
        return HttpService:RequestAsync({
            Url = SERVER_URL .. endpoint,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })
    end)
    if ok and res and res.StatusCode == 200 then
        return true
    end
    local qs = "?pkg=" .. HttpService:UrlEncode(PkgName)
    local ok2, _ = pcall(function()
        return game:HttpGet(SERVER_URL .. endpoint .. qs)
    end)
    return ok2
end

-- Khởi tạo: Đọc PkgName
local function init()
    -- Đợi game load chút
    task.wait(2)
    
    local pkg = AppStorageService:GetItem("PkgName")
    if pkg and pkg ~= "" then
        PkgName = pkg
        log("Detected Package: " .. PkgName)
    else
        PkgName = "com.roblox.client"
        log("Fallback Package: " .. PkgName)
    end
end

-- Tín hiệu 1: Đổi Nick
local function requestChangeAccount()
    if PkgName == "" then return end
    local nonce = HttpService:GenerateGUID(false)
    AppStorageService:SetItem("Signal", "ChangeAccount")
    AppStorageService:SetItem("Nonce", nonce)
    log("Emitting AppStorage ChangeAccount with Nonce: " .. tostring(nonce))
    sendRequest("/change_account", {package = PkgName})
end

-- Tín hiệu 2: Reset Game (Mở lại link VIP/Normal)
local function requestResetGame()
    log("Sending Reset Game Signal...")
    sendRequest("/reset_game", {package = PkgName})
end

-- Tín hiệu 3: Heartbeat (15s/lần)
local function startHeartbeatLoop()
    task.spawn(function()
        while true do
            if PkgName ~= "" then
                sendRequest("/heartbeat", {package = PkgName})
            end
            task.wait(HEARTBEAT_INTERVAL)
        end
    end)
end

-- === MAIN EXECUTION ===
init()
startHeartbeatLoop()

-- EXPORT GLOBAL FUNCTIONS (Để script khác gọi)
getgenv().AutoRoblox = {
    ChangeAccount = requestChangeAccount,
    ResetGame = requestResetGame,
    GetPackage = function() return PkgName end
}

log("Script Loaded! Waiting for signals. Use AutoRoblox.ChangeAccount() or AutoRoblox.ResetGame()")
