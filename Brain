local AppStorageService = game:GetService("AppStorageService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- CONFIG
local SERVER_URL = "http://localhost:8000"
local HEARTBEAT_INTERVAL = 15 -- Giây

-- State
local PkgName = ""

local function log(msg)
    print("[AUTO] " .. tostring(msg))
end

-- Hàm gửi request an toàn
local function sendRequest(endpoint, data)
    if PkgName == "" then return end
    
    local body = HttpService:JSONEncode(data)
    local success, response = pcall(function()
        return HttpService:PostAsync(
            SERVER_URL .. endpoint,
            body,
            Enum.HttpContentType.ApplicationJson
        )
    end)
    
    if not success then
        warn("Request Failed ("..endpoint.."): " .. tostring(response))
    end
    return success
end

-- Khởi tạo: Đọc PkgName
local function init()
    -- Đợi game load chút
    task.wait(2)
    
    local pkg = AppStorageService:GetItem("PkgName")
    if pkg and pkg ~= "" then
        PkgName = pkg
        log("Detected Package: " .. PkgName)
    else
        warn("PkgName not found in AppStorage! Script might not work correctly.")
        -- Fallback test (có thể xóa nếu không cần)
        -- PkgName = "com.roblox.client" 
    end
end

-- Tín hiệu 1: Đổi Nick
local function requestChangeAccount()
    if PkgName == "" then return end
    local nonce = HttpService:GenerateGUID(false)
    AppStorageService:SetItem("Signal", "ChangeAccount")
    AppStorageService:SetItem("Nonce", nonce)
    log("Emitting AppStorage ChangeAccount with Nonce: " .. tostring(nonce))
    sendRequest("/change_account", {package = PkgName})
end

-- Tín hiệu 2: Reset Game (Mở lại link VIP/Normal)
local function requestResetGame()
    log("Sending Reset Game Signal...")
    sendRequest("/reset_game", {package = PkgName})
end

-- Tín hiệu 3: Heartbeat (15s/lần)
local function startHeartbeatLoop()
    task.spawn(function()
        while true do
            if PkgName ~= "" then
                sendRequest("/heartbeat", {package = PkgName})
            end
            task.wait(HEARTBEAT_INTERVAL)
        end
    end)
end

-- === MAIN EXECUTION ===
init()
startHeartbeatLoop()

-- EXPORT GLOBAL FUNCTIONS (Để script khác gọi)
getgenv().AutoRoblox = {
    ChangeAccount = requestChangeAccount,
    ResetGame = requestResetGame,
    GetPackage = function() return PkgName end
}

log("Script Loaded! Waiting for signals. Use AutoRoblox.ChangeAccount() or AutoRoblox.ResetGame()")
