-- ğŸ” AUTO KICK + AUTO REJOIN SAME SERVER (Mobile/PC)
local TS         = game:GetService("TeleportService")
local Players    = game:GetService("Players")
local CoreGui    = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local lp         = Players.LocalPlayer

-- ===== Cáº¤U HÃŒNH =====
local CFG = {
    KICK_EVERY_SECONDS   = 60,     -- má»—i 60s tá»± Kick
    MAX_RETRIES          = 6,      -- sá»‘ láº§n thá»­ Teleport khi lá»—i
    RETRY_BACKOFF_BASE   = 0.8,    -- delay cÆ¡ sá»Ÿ giá»¯a cÃ¡c láº§n retry
    ENABLE_WATCHDOG      = true,   -- phÃ¡t hiá»‡n treo > STALL_SECONDS => rejoin
    STALL_SECONDS        = 12,
    CHECK_INTERVAL       = 2,
}

-- LÆ°u server hiá»‡n táº¡i
local PLACE_ID = game.PlaceId
local JOB_ID   = game.JobId

local REJOINING = false

local function rejoin()
    if REJOINING then return end
    REJOINING = true

    local function attemptSame()
        for i = 1, CFG.MAX_RETRIES do
            local ok, err = pcall(function()
                TS:TeleportToPlaceInstance(PLACE_ID, JOB_ID, lp)
            end)
            if ok then return true end
            warn(("[AutoRejoin] Lá»—i láº§n %d/%d: %s"):format(i, CFG.MAX_RETRIES, tostring(err)))
            task.wait(CFG.RETRY_BACKOFF_BASE + (i-1)*0.5)
        end
        return false
    end

    local ok = attemptSame()
    if not ok then
        -- fallback: vÃ o server má»›i cÃ¹ng PlaceId náº¿u server cÅ© khÃ´ng cÃ²n/Ä‘áº§y
        warn("[AutoRejoin] Fallback â†’ Teleport(PlaceId) (server má»›i)")
        for i = 1, CFG.MAX_RETRIES do
            local ok2 = pcall(function()
                TS:Teleport(PLACE_ID, lp)
            end)
            if ok2 then return end
            task.wait(CFG.RETRY_BACKOFF_BASE + (i-1)*0.5)
        end
        REJOINING = false
    end
end

-- ğŸ”” Báº¯t ErrorPrompt (Disconnected/Kicked/Unexpected Error) â†’ tá»± rejoin
do
    local function hook(container)
        container.DescendantAdded:Connect(function(d)
            if typeof(d) ~= "Instance" then return end
            local name = string.lower(d.Name or "")
            if name:find("errorprompt") then
                task.wait(0.4); rejoin(); return
            end
            if d:IsA("TextLabel") then
                local t = string.lower(d.Text or "")
                if t:find("disconnected") or t:find("kicked") or t:find("unexpected") or (t:find("server") and t:find("closing")) then
                    task.wait(0.4); rejoin()
                end
            end
        end)
    end

    local function tryHookNow()
        local prompt = CoreGui:FindFirstChild("RobloxPromptGui", true)
        if prompt then hook(prompt) end
    end

    tryHookNow()
    CoreGui.ChildAdded:Connect(function(ch)
        if ch.Name == "RobloxPromptGui" then
            task.wait(0.1); tryHookNow()
        end
    end)
end

-- ğŸ›°ï¸ Teleport init fail â†’ rejoin láº¡i
TS.TeleportInitFailed:Connect(function(_, result)
    warn("[AutoRejoin] TeleportInitFailed:", result)
    task.wait(0.6)
    rejoin()
end)

-- ğŸ¶ Watchdog: náº¿u Heartbeat Ä‘á»©ng quÃ¡ lÃ¢u â†’ rejoin
if CFG.ENABLE_WATCHDOG then
    task.spawn(function()
        local lastBeat = tick()
        RunService.Heartbeat:Connect(function() lastBeat = tick() end)
        while task.wait(CFG.CHECK_INTERVAL) do
            if REJOINING then break end
            if (tick() - lastBeat) > CFG.STALL_SECONDS then
                warn("[AutoRejoin] Treo > " .. CFG.STALL_SECONDS .. "s â†’ rejoin")
                rejoin()
                break
            end
        end
    end)
end

-- â›” Tá»° Äá»˜NG KICK THEO CHU Ká»², rá»“i Ä‘á»ƒ hook phÃ­a trÃªn tá»± rejoin láº¡i Ä‘Ãºng server
task.spawn(function()
    while task.wait(CFG.KICK_EVERY_SECONDS) do
        if REJOINING then break end
        -- Ä‘áº£m báº£o Ä‘Ã£ lÆ°u JOB_ID trÆ°á»›c khi Kick (Ä‘Ã£ lÆ°u á»Ÿ trÃªn)
        pcall(function()
            lp:Kick("Auto refresh â€“ rejoin same server")
        end)
        -- Sau Kick sáº½ hiá»‡n ErrorPrompt; hook á»Ÿ trÃªn sáº½ gá»i rejoin()
        -- Náº¿u vÃ¬ lÃ½ do nÃ o Ä‘Ã³ khÃ´ng báº­t prompt, fallback sau 1s:
        task.delay(1.2, function()
            if not REJOINING then rejoin() end
        end)
    end
end)

print(string.format("[AutoKick+Rejoin] Ready. PlaceId=%s  JobId=%s  (chu ká»³ kick %ds)",
    tostring(PLACE_ID), tostring(JOB_ID), CFG.KICK_EVERY_SECONDS))
