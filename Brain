-- üîÅ AUTO REJOIN SERVER (MOBILE, NO UI)
local TS       = game:GetService("TeleportService")
local Players  = game:GetService("Players")
local CoreGui  = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local lp       = Players.LocalPlayer

-- ===== C·∫§U H√åNH =====
local CFG = {
    REJOIN_SAME_SERVER   = true,   -- true: quay l·∫°i ƒë√∫ng server (PlaceId+JobId); false: ch·ªâ PlaceId (server m·ªõi)
    MAX_RETRIES          = 6,      -- s·ªë l·∫ßn retry Teleport khi l·ªói t·∫°m th·ªùi
    RETRY_BACKOFF_BASE   = 0.8,    -- gi√¢y; s·∫Ω tƒÉng d·∫ßn theo l·∫ßn th·ª≠
    ENABLE_WATCHDOG      = true,   -- b·∫≠t watchdog treo m·∫°ng/kh√¥ng Heartbeat
    STALL_SECONDS        = 12,     -- n·∫øu kh√¥ng c√≥ heartbeat qu√° s·ªë gi√¢y n√†y => rejoin
    CHECK_INTERVAL       = 2,      -- chu k·ª≥ ki·ªÉm tra watchdog
    ENABLE_TIMER         = false,  -- n·∫øu mu·ªën t·ª± rejoin theo chu k·ª≥ (vd 60s) th√¨ b·∫≠t true
    TIMER_SECONDS        = 60,
}

local PLACE_ID = game.PlaceId
local JOB_ID   = game.JobId

local REJOINING = false

local function rejoin()
    if REJOINING then return end
    REJOINING = true

    local function attempt()
        for i = 1, CFG.MAX_RETRIES do
            local ok, err = pcall(function()
                if CFG.REJOIN_SAME_SERVER and JOB_ID and JOB_ID ~= "" then
                    TS:TeleportToPlaceInstance(PLACE_ID, JOB_ID, lp)
                else
                    TS:Teleport(PLACE_ID, lp)
                end
            end)
            if ok then return true end
            warn(("[AutoRejoin] L·ªói l·∫ßn %d/%d: %s"):format(i, CFG.MAX_RETRIES, tostring(err)))
            task.wait(CFG.RETRY_BACKOFF_BASE + (i-1)*0.5)
        end
        return false
    end

    local ok = attempt()
    if not ok then
        -- Fallback cu·ªëi: b·ªè JobId (ƒëi v√†o server m·ªõi) n·∫øu v·∫´n fail
        if CFG.REJOIN_SAME_SERVER then
            warn("[AutoRejoin] Fallback ‚Üí Teleport(PlaceId) (server m·ªõi)")
            CFG.REJOIN_SAME_SERVER = false
            attempt()
        end
    end
end

-- 1) T·ª± rejoin khi xu·∫•t hi·ªán ErrorPrompt / Disconnected / Kicked
do
    local function hook(container)
        container.DescendantAdded:Connect(function(d)
            if typeof(d) ~= "Instance" then return end
            local name = string.lower(d.Name or "")
            if name:find("errorprompt") then
                task.wait(0.4)
                rejoin()
                return
            end
            if d:IsA("TextLabel") then
                local t = string.lower(d.Text or "")
                if t:find("disconnected") or t:find("kicked") or t:find("unexpected") or t:find("server") and t:find("closing") then
                    task.wait(0.4)
                    rejoin()
                end
            end
        end)
    end

    local function tryHookNow()
        local prompt = CoreGui:FindFirstChild("RobloxPromptGui", true)
        if prompt then hook(prompt) end
    end

    tryHookNow()
    CoreGui.ChildAdded:Connect(function(ch)
        if ch.Name == "RobloxPromptGui" then
            task.wait(0.1)
            tryHookNow()
        end
    end)
end

-- 2) N·∫øu Teleport b√°o l·ªói init ‚Üí th·ª≠ rejoin l·∫°i
TS.TeleportInitFailed:Connect(function(player, result)
    warn("[AutoRejoin] TeleportInitFailed:", result)
    task.wait(0.6)
    rejoin()
end)

-- 3) Watchdog: n·∫øu Heartbeat ƒë·ª©ng l√¢u ‚Üí rejoin
if CFG.ENABLE_WATCHDOG then
    task.spawn(function()
        local lastBeat = tick()
        RunService.Heartbeat:Connect(function()
            lastBeat = tick()
        end)
        while task.wait(CFG.CHECK_INTERVAL) do
            if REJOINING then break end
            if (tick() - lastBeat) > CFG.STALL_SECONDS then
                warn("[AutoRejoin] Watchdog ph√°t hi·ªán treo > " .. CFG.STALL_SECONDS .. "s ‚Üí rejoin")
                rejoin()
                break
            end
        end
    end)
end

-- 4) Tu·ª≥ ch·ªçn: rejoin theo chu k·ª≥ (VD 60s)
if CFG.ENABLE_TIMER then
    task.spawn(function()
        while task.wait(CFG.TIMER_SECONDS) do
            if not REJOINING then
                rejoin()
            else
                break
            end
        end
    end)
end

print(string.format("[AutoRejoin] Ready. PlaceId=%s  JobId=%s  (SameServer=%s)", tostring(PLACE_ID), tostring(JOB_ID), tostring(CFG.REJOIN_SAME_SERVER)))
