local Players = game:GetService("Players")
local VirtualInput = game:GetService("VirtualInputManager")
local lp = Players.LocalPlayer
local char = lp.Character or lp.CharacterAdded:Wait()
local humanoid = char:WaitForChild("Humanoid")
local hrp = char:WaitForChild("HumanoidRootPart")
print("[auto] init")
local followDistance = 4
local checkInterval = 1.0
local nameKeywords = {"slime","blazing slime"}
local function norm(s)
    s = tostring(s or "")
    s = s:gsub("<.->","")
    s = s:gsub("%s+"," "):gsub("^%s+",""):gsub("%s+$","")
    s = s:lower()
    return s
end
local nNameKeys = {}
for _,k in ipairs(nameKeywords) do
    local t = norm(k)
    if t ~= "" then table.insert(nNameKeys, t) end
end
local function matchAny(raw, keys)
    if not raw or #keys == 0 then return false end
    local s = norm(raw)
    for _,k in ipairs(keys) do
        if s:find(k, 1, true) then return true end
    end
    return false
end
local Candidates = {}
local function attachCandidate(model, root, label)
    if not model or not root then return end
    Candidates[model] = {model=model, root=root, label=label}
end
local function tryAddFromLabel(label)
    local raw = (label.ContentText ~= nil) and label.ContentText or label.Text
    if not matchAny(raw, nNameKeys) then return end
    local model = label:FindFirstAncestorOfClass("Model"); if not model then return end
    local root  = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart", true)
    if not root then return end
    attachCandidate(model, root, label)
end
local function tryAddFromModel(model)
    local root = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart", true)
    if not root then return end
    local ok = matchAny(model.Name, nNameKeys)
    if not ok then
        for _,gui in ipairs(model:GetDescendants()) do
            if gui:IsA("TextLabel") then
                local t = (gui.ContentText ~= nil) and gui.ContentText or gui.Text
                if matchAny(t, nNameKeys) then ok = true; break end
            end
        end
    end
    if ok then attachCandidate(model, root, nil) end
end
local function initialScan()
    Candidates = {}
    for _, d in ipairs(workspace:GetDescendants()) do
        if d:IsA("TextLabel") then
            tryAddFromLabel(d)
        elseif d:IsA("Model") then
            tryAddFromModel(d)
        end
    end
end
initialScan()
local addQueue = {}
local removingSet = setmetatable({}, {__mode = "k"})
workspace.DescendantAdded:Connect(function(obj)
    table.insert(addQueue, obj)
end)
workspace.DescendantRemoving:Connect(function(obj)
    local m = obj:IsA("Model") and obj or obj:FindFirstAncestorOfClass("Model")
    if m then removingSet[m] = true end
end)
local MAX_PER_TICK = 60
task.spawn(function()
    while true do
        for m,_ in pairs(removingSet) do
            Candidates[m] = nil
            removingSet[m] = nil
        end
        local processed = 0
        while processed < MAX_PER_TICK and #addQueue > 0 do
            processed = processed + 1
            local obj = table.remove(addQueue, 1)
            if obj and obj.Parent then
                if obj:IsA("TextLabel") then
                    pcall(tryAddFromLabel, obj)
                elseif obj:IsA("Model") then
                    pcall(tryAddFromModel, obj)
                end
            end
        end
        task.wait(0.02)
    end
end)
local function findClosestPet()
    local nearest, bestDist = nil, math.huge
    for _, info in pairs(Candidates) do
        local model = info.model
        local root  = info.root
        if model and root and model:IsDescendantOf(workspace) then
            local pos = root.Position
            local dist = (hrp.Position - pos).Magnitude
            if dist < bestDist then
                bestDist = dist
                nearest  = info
            end
        end
    end
    return nearest
end
local function findTool(names)
    local function f(container)
        if not container then return nil end
        for _,v in ipairs(container:GetChildren()) do
            if v:IsA("Tool") then
                local n = v.Name:lower()
                for _,k in ipairs(names) do
                    if n:find(k) then return v end
                end
            end
        end
        return nil
    end
    return f(lp.Backpack) or f(char) or f(lp:FindFirstChild("StarterGear")) or f(lp:FindFirstChild("Weapon")) or f(lp:FindFirstChild("Tools"))
end
local function ensureEquipWeapon()
    local t = findTool({"weapon","sword","blade","pickaxe"})
    if t then
        if t.Parent ~= char then pcall(function() humanoid:EquipTool(t) end) end
        return t
    end
    return nil
end
local function parseHP(model)
    for _,gui in ipairs(model:GetDescendants()) do
        if gui:IsA("TextLabel") then
            local txt = (gui.ContentText ~= nil) and gui.ContentText or gui.Text
            if txt and txt:lower():find("hp") then
                local n = tonumber((txt:lower():match("([%d%.]+)%s*hp")))
                if n then return n end
            end
        end
    end
    return nil
end
local function tapCenter()
    local cam = workspace.CurrentCamera
    if not cam then return end
    local v = cam.ViewportSize
    local x, y = v.X/2, v.Y/2
    VirtualInput:SendMouseButtonEvent(x, y, 0, true, game, 0)
    VirtualInput:SendMouseButtonEvent(x, y, 0, false, game, 0)
end
local function attackLoop(pet)
    local alive = true
    task.spawn(function()
        while alive and pet.model:IsDescendantOf(workspace) do
            if not hrp or not humanoid then break end
            local pos = pet.root.Position
            local dist = (hrp.Position - pos).Magnitude
            if dist > 120 then
                hrp.CFrame = CFrame.new(pos + Vector3.new(0, 6, 0))
            elseif dist > followDistance then
                humanoid:MoveTo(Vector3.new(pos.X, hrp.Position.Y, pos.Z))
            end
            task.wait(0.1)
        end
    end)
    local start = os.clock()
    print("[auto] engage target")
    while pet.model:IsDescendantOf(workspace) do
        if not hrp or not humanoid then break end
        local t = ensureEquipWeapon()
        if t then pcall(function() t:Activate() end) end
        tapCenter()
        local hp = parseHP(pet.model)
        if hp and hp <= 0 then break end
        if os.clock() - start > 30 then break end
        task.wait(0.12)
    end
    alive = false
end
local lastPet
task.spawn(function()
    while true do
        task.wait(checkInterval)
        local pet = findClosestPet()
        if pet and (not lastPet or pet.model ~= lastPet.model) then
            lastPet = pet
            attackLoop(pet)
        elseif not pet then
            lastPet = nil
        end
    end
end)
