local HttpService = game:GetService("HttpService")
local AppStorageService = game:GetService("AppStorageService")
local Players = game:GetService("Players")
local SERVER = (AppStorageService:GetItem("ServerUrl") or "http://192.168.1.103:8001")
local function post(url, body)
    local data = HttpService:JSONEncode(body)
    local ok, res = pcall(function()
        return HttpService:RequestAsync({Url = url, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = data})
    end)
    if ok and res and res.Success then return true, res.StatusCode end
    if syn and syn.request then
        local r = syn.request({Url = url, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = data})
        if r and r.StatusCode and r.StatusCode >= 200 and r.StatusCode < 300 then return true, r.StatusCode end
    end
    if http_request then
        local r = http_request({Url = url, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = data})
        if r and r.StatusCode and r.StatusCode >= 200 and r.StatusCode < 300 then return true, r.StatusCode end
    end
    if request then
        local r = request({Url = url, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = data})
        local code = (r and (r.StatusCode or r.status_code)) or 0
        if code >= 200 and code < 300 then return true, code end
    end
    return false, 0
end
local session_id = tostring(math.random(1000000000)) .. "-" .. tostring(os.time())
local function send_event(t, payload)
    local p = payload or {}
    p.session = session_id
    p.place_id = game.PlaceId
    p.job_id = game.JobId
    local lp = Players.LocalPlayer
    if lp then p.user_id = lp.UserId end
    p.at = os.time()
    local ok = post(SERVER .. "/event", {type = t, data = p})
    return ok
end
local function handshake()
    local pkg = AppStorageService:GetItem("PkgName") or ""
    post(SERVER .. "/handshake", {session = session_id, package = pkg, place_id = game.PlaceId, job_id = game.JobId, user_id = (Players.LocalPlayer and Players.LocalPlayer.UserId) or 0, at = os.time()})
end
handshake()
send_event("change_account", {package = AppStorageService:GetItem("PkgName") or ""})
task.spawn(function()
    while true do
        send_event("heartbeat")
        task.wait(5)
    end
end)
